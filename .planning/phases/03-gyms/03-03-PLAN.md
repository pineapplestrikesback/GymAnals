---
phase: 03-gyms
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - GymAnals/Features/Workout/Views/GymManagementView.swift
  - GymAnals/Features/Workout/ViewModels/GymManagementViewModel.swift
  - GymAnals/Features/Workout/Views/GymEditView.swift
  - GymAnals/Features/Workout/Components/GymColorPicker.swift
autonomous: true

must_haves:
  truths:
    - "User can see list of all gyms with workout count"
    - "User can create a new gym with name and color"
    - "User can edit existing gym name and color"
    - "User can delete user-created gyms (not Default Gym)"
    - "User is presented with delete options: delete all, keep history, merge"
  artifacts:
    - path: "GymAnals/Features/Workout/Views/GymManagementView.swift"
      provides: "List view for gym CRUD operations"
      contains: "GymManagementView"
    - path: "GymAnals/Features/Workout/ViewModels/GymManagementViewModel.swift"
      provides: "Business logic for gym management"
      contains: "GymManagementViewModel"
    - path: "GymAnals/Features/Workout/Views/GymEditView.swift"
      provides: "Form for creating/editing gym"
      contains: "GymEditView"
    - path: "GymAnals/Features/Workout/Components/GymColorPicker.swift"
      provides: "Predefined color palette picker"
      contains: "GymColorPicker"
  key_links:
    - from: "GymManagementView.swift"
      to: "GymEditView.swift"
      via: "NavigationLink for add/edit"
      pattern: "NavigationLink.*GymEditView"
    - from: "GymManagementView.swift"
      to: "confirmationDialog"
      via: "deletion options"
      pattern: "\\.confirmationDialog"
    - from: "GymEditView.swift"
      to: "GymColorPicker.swift"
      via: "color selection"
      pattern: "GymColorPicker"
---

<objective>
Create full gym management interface with CRUD operations and deletion options.

Purpose: Users need to manage multiple gyms - create gyms for different locations, rename them, change colors, and delete old gyms with appropriate handling of associated workout history.

Output: GymManagementView, GymEditView, GymColorPicker, and supporting ViewModel.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-gyms/03-CONTEXT.md
@.planning/phases/03-gyms/03-RESEARCH.md
@.planning/phases/03-gyms/03-01-SUMMARY.md

# Existing patterns
@GymAnals/Features/ExerciseLibrary/ViewModels/MuscleWeightViewModel.swift (ViewModel pattern)
@GymAnals/Models/Core/Gym.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GymColorPicker and GymEditView</name>
  <files>
    GymAnals/Features/Workout/Components/GymColorPicker.swift
    GymAnals/Features/Workout/Views/GymEditView.swift
  </files>
  <action>
Create GymColorPicker.swift:
- struct GymColorPicker: View
- @Binding var selectedColor: GymColor
- Body: Picker with .palette style
  - ForEach GymColor.allCases
  - Each option: Circle filled with gymColor.color (24pt), tagged with gymColor
- Label: "Color"

Create GymEditView.swift:
- struct GymEditView: View
- @Environment(\.modelContext) private var modelContext
- @Environment(\.dismiss) private var dismiss
- @State private var name: String
- @State private var colorTag: GymColor
- let gym: Gym? (nil for new gym)

Init:
- If gym provided, initialize name and colorTag from gym
- If nil, initialize with empty name and .blue color

Body: Form with:
- Section: TextField for "Gym Name" with name binding
- Section: GymColorPicker with colorTag binding

navigationTitle: gym == nil ? "New Gym" : "Edit Gym"
.inline display mode

Toolbar:
- .cancellationAction: Cancel button dismissing
- .confirmationAction: Save button
  - If gym is nil, create new Gym and insert
  - If gym exists, update gym.name and gym.colorTag
  - Save context, dismiss
  - Disable Save if name.trimmingCharacters(in: .whitespaces).isEmpty

Note: For existing gym, check !gym.isDefault before allowing name edit (Default Gym name is fixed).
  </action>
  <verify>
Build succeeds. Color picker shows 8 colors in palette. Edit view has name field and color picker.
  </verify>
  <done>
GymColorPicker shows palette of 8 colors, GymEditView allows creating and editing gyms with validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GymManagementViewModel and GymManagementView with deletion handling</name>
  <files>
    GymAnals/Features/Workout/ViewModels/GymManagementViewModel.swift
    GymAnals/Features/Workout/Views/GymManagementView.swift
  </files>
  <action>
Create GymManagementViewModel.swift:
- @Observable @MainActor final class GymManagementViewModel
- private let modelContext: ModelContext
- init(modelContext: ModelContext)

Methods:
- deleteGymWithHistory(gym: Gym):
  - Simply delete the gym (cascade handles workouts and history)
  - Save context

- deleteGymKeepHistory(gym: Gym):
  - Set each workout's gym to nil
  - Set each weightHistory's gym to nil
  - Delete gym, save

- mergeGym(from: Gym, to: Gym):
  - For each workout in from.workouts: set workout.gym = to
  - For each history in from.weightHistory: set history.gym = to
  - Update to.lastUsedDate if from.lastUsedDate is more recent
  - Delete from gym, save

Create GymManagementView.swift:
- struct GymManagementView: View
- @Environment(\.modelContext) private var modelContext
- @Query(sort: \Gym.lastUsedDate, order: .reverse) private var gyms: [Gym]
- @State private var viewModel: GymManagementViewModel?
- @State private var gymToDelete: Gym?
- @State private var showingDeleteOptions = false
- @State private var showingMergeSheet = false

Body: List with:
- ForEach gyms showing:
  - NavigationLink to GymEditView(gym: gym)
  - Row: color circle (16pt), gym name, workout count badge
  - .swipeActions: delete button (disabled if gym.isDefault)
    - On tap: set gymToDelete, showingDeleteOptions = true

- Empty state if gyms.isEmpty (shouldn't happen due to Default Gym)

Toolbar: Add button (+) navigating to GymEditView(gym: nil)

.onAppear: initialize viewModel

.confirmationDialog for deletion:
- Title: "Delete \(gymToDelete?.name ?? "Gym")?"
- Message: "What should happen to workouts recorded at this gym?"
- Buttons:
  1. "Delete Gym and History" (destructive) -> deleteGymWithHistory
  2. "Delete Gym, Keep History" -> deleteGymKeepHistory
  3. "Merge into Another Gym..." -> showingMergeSheet = true
  4. "Cancel" (cancel role)

.sheet for merge gym selection:
- Simple list of gyms (excluding gymToDelete)
- Selecting a gym calls mergeGym and dismisses
  </action>
  <verify>
1. Build succeeds
2. Run app - navigate to gym management (from selector sheet or directly)
3. Can add new gym with name and color
4. Can edit existing gym (not Default Gym name)
5. Swiping reveals delete for non-default gyms
6. Delete confirmation shows three options
  </verify>
  <done>
GymManagementView lists gyms with workout counts, supports add/edit, and provides three deletion options via confirmationDialog.
  </done>
</task>

</tasks>

<verification>
1. Build: `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build`
2. Test gym management flow:
   - Add a new gym with custom name and color
   - Edit the gym's color
   - Try to delete (see three options)
   - Verify Default Gym cannot be deleted
</verification>

<success_criteria>
- GymColorPicker displays 8-color palette
- GymEditView validates name is not empty
- GymManagementView shows all gyms with workout count
- Default Gym delete action is disabled
- User-created gyms show confirmationDialog with 3 options
- Merge option allows selecting target gym
</success_criteria>

<output>
After completion, create `.planning/phases/03-gyms/03-03-SUMMARY.md`
</output>
