---
phase: 03-gyms
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - GymAnals/Features/Workout/Views/WorkoutTabView.swift
  - GymAnals/Features/Workout/Views/GymSelectorSheet.swift
  - GymAnals/Features/ExerciseLibrary/Views/ExerciseDetailView.swift
autonomous: true

must_haves:
  truths:
    - "User can access gym management from gym selector sheet"
    - "User can see gym-specific weight history in exercise detail"
    - "Exercise branches display gym color and name"
    - "Gym management integrates with workout tab flow"
  scope_note: |
    Phase 3 builds MODEL infrastructure (Gym model with relationships to WeightHistory)
    and DISPLAY infrastructure (gym branches section in ExerciseDetailView).
    Actual branch CREATION happens in Phase 4 (Workout Logging) when user logs sets
    and chooses "Track at this gym" - this is when WeightHistory records get their gym association.
  artifacts:
    - path: "GymAnals/Features/Workout/Views/WorkoutTabView.swift"
      provides: "Complete gym selection flow with management navigation"
      contains: "showingGymManagement"
    - path: "GymAnals/Features/ExerciseLibrary/Views/ExerciseDetailView.swift"
      provides: "Gym branches section showing weight history by gym"
      contains: "Weight History by Gym"
  key_links:
    - from: "GymSelectorSheet.swift"
      to: "GymManagementView.swift"
      via: "onManageGyms callback"
      pattern: "onManageGyms"
    - from: "ExerciseDetailView.swift"
      to: "Exercise.weightHistory"
      via: "grouped by gym"
      pattern: "grouping.*weightHistory"
---

<objective>
Wire gym management into selector flow and add gym branches section to exercise detail.

Purpose: Connect all gym UI pieces into a cohesive flow. Users can manage gyms from the selector sheet, and see which gyms they've used each exercise at with entry counts.

Output: Completed gym selector -> management flow, exercise detail with gym history section.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-gyms/03-CONTEXT.md
@.planning/phases/03-gyms/03-RESEARCH.md
@.planning/phases/03-gyms/03-01-SUMMARY.md
@.planning/phases/03-gyms/03-02-SUMMARY.md
@.planning/phases/03-gyms/03-03-SUMMARY.md

# Files to update
@GymAnals/Features/Workout/Views/WorkoutTabView.swift
@GymAnals/Features/Workout/Views/GymSelectorSheet.swift
@GymAnals/Features/ExerciseLibrary/Views/ExerciseDetailView.swift
@GymAnals/Models/Core/Exercise.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire gym management sheet into WorkoutTabView flow</name>
  <files>
    GymAnals/Features/Workout/Views/WorkoutTabView.swift
    GymAnals/Features/Workout/Views/GymSelectorSheet.swift
  </files>
  <action>
NOTE: Plan 02 created GymSelectorSheet with an onManageGyms callback, but at that time
GymManagementView did not exist. The callback currently just dismisses the sheet.
This task UPDATES that stub implementation to actually navigate to GymManagementView (created in Plan 03).

Update WorkoutTabView.swift to add gym management sheet:
- Ensure @State private var showingGymManagement = false exists (from Plan 02)
- Add .sheet(isPresented: $showingGymManagement):
  - NavigationStack containing GymManagementView()
  - .presentationDetents([.large])
- Update the onManageGyms callback implementation to:
  1. Dismiss gym selector (via dismiss or showingGymSelector = false)
  2. After slight delay, set showingGymManagement = true

Use DispatchQueue.main.asyncAfter(deadline: .now() + 0.3) to prevent sheet transition conflicts.

GymSelectorSheet.swift should already have the onManageGyms callback wired from Plan 02.
Only update if the callback implementation needs adjustment.

Verify the flow:
1. User taps gym header -> selector sheet opens
2. User taps "Manage Gyms" -> selector closes, management opens
3. User can add/edit/delete gyms
4. Dismissing management returns to workout tab
  </action>
  <verify>
1. Build succeeds
2. Run app - tap gym header, tap "Manage Gyms"
3. Selector dismisses, management opens after brief moment
4. Can navigate back cleanly
  </verify>
  <done>
Gym management accessible from selector sheet, smooth sheet transitions work correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add gym branches section to ExerciseDetailView</name>
  <files>
    GymAnals/Features/ExerciseLibrary/Views/ExerciseDetailView.swift
  </files>
  <action>
Update ExerciseDetailView.swift to show gym-specific weight history:

Add computed property gymBranches:
```swift
private var gymBranches: [(gym: Gym, entryCount: Int)] {
    guard let exercise = exercise else { return [] }

    // Group weight history by gym
    let grouped = Dictionary(grouping: exercise.weightHistory) { $0.gym }

    // Filter out entries with nil gym using compactMap.
    // nil gym records exist when user chose "Delete Gym, Keep History" -
    // this is valid orphaned history but should NOT appear as a "branch"
    // since there's no gym to display it under.
    return grouped.compactMap { gym, entries in
        guard let gym = gym else { return nil }
        return (gym: gym, entryCount: entries.count)
    }
    .sorted {
        ($0.gym.lastUsedDate ?? .distantPast) > ($1.gym.lastUsedDate ?? .distantPast)
    }
}
```

Add new Section after existing sections (after the "Custom Exercise" section):
```swift
if !gymBranches.isEmpty {
    Section("Weight History by Gym") {
        ForEach(gymBranches, id: \.gym.id) { branch in
            HStack {
                Circle()
                    .fill(branch.gym.colorTag.color)
                    .frame(width: 12, height: 12)
                Text(branch.gym.name)
                Spacer()
                Text("\(branch.entryCount) \(branch.entryCount == 1 ? "entry" : "entries")")
                    .foregroundStyle(.secondary)
            }
        }
    }
}
```

Note: Per CONTEXT.md, branches only show in exercise detail (not main library). This section only appears when weight history exists for this exercise at any gym.

Note: Navigation to detailed gym weight history view is deferred to Phase 4 (Workout Logging) when actual weight history will be created.
  </action>
  <verify>
1. Build succeeds
2. Open an exercise detail view
3. If exercise has weight history at gyms, section appears
4. If no history, section is hidden
5. Each gym row shows color, name, and entry count
  </verify>
  <done>
Exercise detail shows "Weight History by Gym" section when history exists, displaying gym color, name, and entry count for each gym branch.
  </done>
</task>

</tasks>

<verification>
1. Build: `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build`
2. Full user flow test:
   - Open workout tab -> tap gym header -> selector sheet
   - Tap "Manage Gyms" -> management view opens
   - Add a gym -> return to workout tab
   - Open exercise library -> tap an exercise
   - (If weight history exists) See gym branches section
</verification>

<success_criteria>
- Gym management accessible via "Manage Gyms" button in selector sheet
- Sheet transitions are smooth (no visual glitches)
- ExerciseDetailView shows gym branches when weight history exists
- Gym branches display color dot, name, and entry count
- Section hidden when no weight history
</success_criteria>

<output>
After completion, create `.planning/phases/03-gyms/03-04-SUMMARY.md`
</output>
