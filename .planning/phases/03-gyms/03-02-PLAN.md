---
phase: 03-gyms
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - GymAnals/Features/Workout/ViewModels/GymSelectionViewModel.swift
  - GymAnals/Features/Workout/Components/GymSelectorHeader.swift
  - GymAnals/Features/Workout/Views/GymSelectorSheet.swift
  - GymAnals/Features/Workout/Views/WorkoutTabView.swift
autonomous: true

must_haves:
  truths:
    - "User can see currently selected gym in workout tab header"
    - "User can tap gym header to open selection sheet"
    - "User can select a different gym from the sheet"
    - "Selected gym persists between app sessions"
    - "Default gym is auto-selected on first launch"
  artifacts:
    - path: "GymAnals/Features/Workout/ViewModels/GymSelectionViewModel.swift"
      provides: "Gym selection state with @AppStorage persistence"
      contains: "@AppStorage"
    - path: "GymAnals/Features/Workout/Components/GymSelectorHeader.swift"
      provides: "Tappable gym name with color dot"
      contains: "GymSelectorHeader"
    - path: "GymAnals/Features/Workout/Views/GymSelectorSheet.swift"
      provides: "Sheet listing all gyms for selection"
      contains: "GymSelectorSheet"
    - path: "GymAnals/Features/Workout/Views/WorkoutTabView.swift"
      provides: "Updated tab with gym selector integration"
      contains: "GymSelectorHeader"
  key_links:
    - from: "WorkoutTabView.swift"
      to: "GymSelectorHeader.swift"
      via: "view composition"
      pattern: "GymSelectorHeader"
    - from: "WorkoutTabView.swift"
      to: "GymSelectorSheet.swift"
      via: ".sheet presentation"
      pattern: "\\.sheet.*GymSelectorSheet"
    - from: "GymSelectionViewModel.swift"
      to: "@AppStorage"
      via: "UUID string persistence"
      pattern: "@AppStorage.*selectedGymID"
---

<objective>
Add gym selector to workout tab with persistent selection across app sessions.

Purpose: Users need to select which gym they're training at before starting a workout. This selection persists so returning users see their last gym automatically.

Output: Gym selection ViewModel, header component, selection sheet, and integrated WorkoutTabView.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-gyms/03-CONTEXT.md
@.planning/phases/03-gyms/03-RESEARCH.md
@.planning/phases/03-gyms/03-01-SUMMARY.md

# Existing patterns
@GymAnals/Features/Workout/Views/WorkoutTabView.swift
@GymAnals/Models/Core/Gym.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GymSelectionViewModel with @AppStorage persistence</name>
  <files>
    GymAnals/Features/Workout/ViewModels/GymSelectionViewModel.swift
  </files>
  <action>
Create directory GymAnals/Features/Workout/ViewModels/ if needed.

Create GymSelectionViewModel.swift:
- @Observable @MainActor final class GymSelectionViewModel
- @ObservationIgnored @AppStorage("selectedGymID") private var selectedGymIDString: String = ""
- private let modelContext: ModelContext
- init(modelContext: ModelContext)

Computed property selectedGym: Gym? with:
- getter: Parse UUID from selectedGymIDString, fetch Gym with that ID, return first result or nil
- setter: Store newValue?.id.uuidString ?? "" to selectedGymIDString

Method ensureDefaultSelection():
- If selectedGymIDString is empty or no gym found for ID:
  - Fetch gym where isDefault == true
  - If found, set selectedGymIDString to that gym's UUID
- Call this in init after storing modelContext

Method gyms: [Gym] (computed or fetched):
- Return all gyms sorted by lastUsedDate descending (most recent first)
- Use FetchDescriptor with SortDescriptor

Why @ObservationIgnored on @AppStorage: Prevents double-triggering when SwiftUI's @AppStorage and @Observable both observe changes.
  </action>
  <verify>
Build succeeds. ViewModel can be instantiated with a ModelContext.
  </verify>
  <done>
GymSelectionViewModel manages gym selection with UUID persistence in @AppStorage, auto-selects default gym on first launch.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create gym selector UI components and integrate into WorkoutTabView</name>
  <files>
    GymAnals/Features/Workout/Components/GymSelectorHeader.swift
    GymAnals/Features/Workout/Views/GymSelectorSheet.swift
    GymAnals/Features/Workout/Views/WorkoutTabView.swift
  </files>
  <action>
Create directory GymAnals/Features/Workout/Components/ if needed.

Create GymSelectorHeader.swift:
- struct GymSelectorHeader: View
- Properties: gym: Gym?, onTap: () -> Void
- Body: Button with HStack containing:
  - Circle filled with gym?.colorTag.color ?? .gray (12pt)
  - Text(gym?.name ?? "Select Gym") as subheadline
  - chevron.down image (caption2, secondary)
- Style: .plain buttonStyle, capsule background with .regularMaterial

Create GymSelectorSheet.swift:
- struct GymSelectorSheet: View
- @Environment(\.modelContext) private var modelContext
- @Environment(\.dismiss) private var dismiss
- @Query(sort: \Gym.lastUsedDate, order: .reverse) private var gyms: [Gym]
- @Binding var selectedGym: Gym?
- let onManageGyms: () -> Void

Body: NavigationStack with List:
- ForEach gyms: Button that sets selectedGym, updates gym.lastUsedDate, dismisses
  - Row: color circle (16pt), gym name, checkmark if selected
- Section at bottom: "Manage Gyms" button that dismisses then calls onManageGyms

navigationTitle("Select Gym"), .inline display mode
Toolbar: cancel button

Update WorkoutTabView.swift:
- Add @Environment(\.modelContext) private var modelContext
- Add @State private var viewModel: GymSelectionViewModel?
- Add @State private var showingGymSelector = false
- Add @State private var showingGymManagement = false

In body, add above "Start Workout" button:
- HStack with Spacer, GymSelectorHeader(gym: viewModel?.selectedGym) { showingGymSelector = true }, Spacer

Add .onAppear: initialize viewModel if nil

Add .sheet(isPresented: $showingGymSelector):
- GymSelectorSheet with binding to viewModel's selectedGym
- onManageGyms: dismiss selector, set showingGymManagement = true
- .presentationDetents([.medium])
- .presentationDragIndicator(.visible)

Note: GymManagementView will be created in Plan 03 - for now, onManageGyms just dismisses.
  </action>
  <verify>
1. Build succeeds
2. Run app - workout tab shows gym selector header with "Default Gym"
3. Tap header - sheet opens with gym list
4. Select gym - sheet dismisses, header updates
5. Force-quit and relaunch - previously selected gym persists
  </verify>
  <done>
Workout tab displays gym selector header, tapping opens selection sheet, selection persists across app restarts.
  </done>
</task>

</tasks>

<verification>
1. Build: `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build`
2. Run app and verify:
   - Gym selector header visible in Workout tab
   - Tapping opens sheet with gym list
   - Selecting a gym updates header
   - App restart preserves selection
</verification>

<success_criteria>
- GymSelectorHeader shows gym name and color dot
- GymSelectorSheet lists all gyms with selection indicator
- Selected gym persists via @AppStorage
- Default gym auto-selected on first launch
- WorkoutTabView integrates selector cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-gyms/03-02-SUMMARY.md`
</output>
