---
phase: 05-exercise-library-rework
plan: 10
type: execute
wave: 6
depends_on:
  - "09"
files_modified:
  - GymAnals/Features/ExerciseLibrary/Views/ExerciseSearchResultsView.swift
  - GymAnals/Features/ExerciseLibrary/Views/ExerciseRow.swift
  - GymAnals/Features/ExerciseLibrary/Views/ExerciseDetailView.swift
  - GymAnals/Features/ExerciseLibrary/Views/ExerciseLibraryView.swift
  - GymAnals/Features/ExerciseLibrary/Components/MuscleGroupFilterTabs.swift
  - GymAnals/Features/Workout/Views/ExercisePickerSheet.swift
autonomous: true

must_haves:
  truths:
    - "Exercise library views work with new Exercise model"
    - "Search filters work with searchTerms array in-memory"
    - "No Variant references in library views"
    - "Exercise detail shows muscleWeights dictionary content"
    - "All views compile and display data correctly"
  artifacts:
    - path: "GymAnals/Features/ExerciseLibrary/Views/ExerciseSearchResultsView.swift"
      provides: "Exercise search with in-memory filtering"
      contains: "searchTerms"
  key_links:
    - from: "ExerciseSearchResultsView.swift"
      to: "Exercise.swift"
      via: "@Query fetch"
      pattern: "@Query.*Exercise"
---

<objective>
Update Exercise Library views to work with the refactored Exercise model.

Purpose: Ensure all exercise browsing, searching, and detail views work with the new dimensions-based model.
Output: Fully functional exercise library without Variant dependencies.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-exercise-library-rework/05-CONTEXT.md
@.planning/phases/05-exercise-library-rework/05-RESEARCH.md
@GymAnals/Features/ExerciseLibrary/Views/ExerciseSearchResultsView.swift
@GymAnals/Features/ExerciseLibrary/Views/ExerciseRow.swift
@GymAnals/Features/ExerciseLibrary/Views/ExerciseDetailView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ExerciseSearchResultsView with in-memory filtering</name>
  <files>
    GymAnals/Features/ExerciseLibrary/Views/ExerciseSearchResultsView.swift
  </files>
  <action>
Update ExerciseSearchResultsView to:
1. Query all exercises (can't query searchTerms array via predicate)
2. Filter in-memory for search text matching displayName, searchTerms, or movement name
3. Filter by muscle group using primaryMuscleGroup computed property or movement.category

```swift
import SwiftUI
import SwiftData

struct ExerciseSearchResultsView: View {
    let searchText: String
    let muscleGroup: MuscleGroup?

    @Query private var allExercises: [Exercise]

    init(searchText: String, muscleGroup: MuscleGroup?) {
        self.searchText = searchText
        self.muscleGroup = muscleGroup
        // Fetch all exercises - filtering done in-memory
        _allExercises = Query(sort: \Exercise.displayName)
    }

    /// Exercises filtered by search text (in-memory since searchTerms can't be queried)
    private var searchFilteredExercises: [Exercise] {
        if searchText.isEmpty {
            return allExercises
        }
        let lowered = searchText.lowercased()
        return allExercises.filter { exercise in
            exercise.displayName.localizedCaseInsensitiveContains(searchText) ||
            exercise.searchTerms.contains { $0.lowercased().contains(lowered) } ||
            exercise.movement?.displayName.localizedCaseInsensitiveContains(searchText) == true
        }
    }

    /// Final filtered list (search + muscle group)
    private var filteredExercises: [Exercise] {
        guard let group = muscleGroup else {
            return searchFilteredExercises
        }
        return searchFilteredExercises.filter { $0.primaryMuscleGroup == group }
    }

    var body: some View {
        List {
            if filteredExercises.isEmpty {
                ContentUnavailableView {
                    Label("No Exercises", systemImage: "dumbbell")
                } description: {
                    if !searchText.isEmpty {
                        Text("No exercises match '\(searchText)'")
                    } else if muscleGroup != nil {
                        Text("No exercises in this category")
                    } else {
                        Text("Add exercises to get started")
                    }
                }
            } else {
                ForEach(filteredExercises, id: \.id) { exercise in
                    NavigationLink(value: exercise) {
                        ExerciseRow(exercise: exercise)
                    }
                }
            }
        }
        .navigationDestination(for: Exercise.self) { exercise in
            ExerciseDetailView(exercise: exercise)
        }
    }
}
```

Key changes:
1. In-memory filtering for searchTerms (SwiftData can't query array contents)
2. Filter by primaryMuscleGroup (computed from muscleWeights)
3. Uses Exercise.displayName directly (no longer via variant)
  </action>
  <verify>
Build project - view should compile. Test search functionality.
  </verify>
  <done>
ExerciseSearchResultsView updated with in-memory search filtering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ExerciseRow</name>
  <files>
    GymAnals/Features/ExerciseLibrary/Views/ExerciseRow.swift
  </files>
  <action>
Update ExerciseRow to use the new Exercise model:

```swift
import SwiftUI

struct ExerciseRow: View {
    let exercise: Exercise

    var body: some View {
        VStack(alignment: .leading, spacing: 4) {
            Text(exercise.displayName)
                .font(.body)

            HStack(spacing: 8) {
                // Equipment badge
                if let equipment = exercise.equipment {
                    Text(equipment.displayName)
                        .font(.caption)
                        .foregroundStyle(.secondary)
                }

                // Movement category badge
                if let movement = exercise.movement {
                    Text(movement.category.displayName)
                        .font(.caption)
                        .padding(.horizontal, 6)
                        .padding(.vertical, 2)
                        .background(Color.secondary.opacity(0.2))
                        .clipShape(Capsule())
                }

                Spacer()

                // Favorite indicator
                if exercise.isFavorite {
                    Image(systemName: "star.fill")
                        .foregroundStyle(.yellow)
                        .font(.caption)
                }
            }
        }
        .padding(.vertical, 4)
    }
}

#Preview {
    List {
        ExerciseRow(exercise: Exercise(displayName: "Barbell Bench Press"))
    }
    .modelContainer(PersistenceController.preview)
}
```

Key changes:
1. Uses `exercise.displayName` directly (no longer via variant)
2. Uses `exercise.equipment?.displayName`
3. Uses `exercise.movement?.category.displayName` for category badge
4. Removed any `variant` references
  </action>
  <verify>
Build project - row should compile and display correctly.
  </verify>
  <done>
ExerciseRow updated to use Exercise.displayName and movement.category.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ExerciseDetailView</name>
  <files>
    GymAnals/Features/ExerciseLibrary/Views/ExerciseDetailView.swift
  </files>
  <action>
Update ExerciseDetailView to show the new Exercise model data:

```swift
import SwiftUI

struct ExerciseDetailView: View {
    let exercise: Exercise
    @State private var showingMuscleEditor = false

    var body: some View {
        List {
            // Basic info section
            Section("Details") {
                if let equipment = exercise.equipment {
                    LabeledContent("Equipment", value: equipment.displayName)
                }

                if let movement = exercise.movement {
                    LabeledContent("Movement", value: movement.displayName)
                    LabeledContent("Category", value: movement.category.displayName)
                }

                if exercise.isUnilateral {
                    LabeledContent("Type", value: "Unilateral")
                }

                LabeledContent("Popularity", value: exercise.popularity.displayName)
            }

            // Dimensions section (if any set)
            if !exercise.dimensions.isEmpty {
                Section("Variation") {
                    if !exercise.dimensions.angle.isEmpty {
                        LabeledContent("Angle", value: formatDimension(exercise.dimensions.angle))
                    }
                    if !exercise.dimensions.gripWidth.isEmpty {
                        LabeledContent("Grip Width", value: formatDimension(exercise.dimensions.gripWidth))
                    }
                    if !exercise.dimensions.gripOrientation.isEmpty {
                        LabeledContent("Grip", value: formatDimension(exercise.dimensions.gripOrientation))
                    }
                    if !exercise.dimensions.stance.isEmpty {
                        LabeledContent("Stance", value: formatDimension(exercise.dimensions.stance))
                    }
                }
            }

            // Muscle weights section
            Section {
                if exercise.sortedMuscleWeights.isEmpty {
                    Text("No muscles assigned")
                        .foregroundStyle(.secondary)
                } else {
                    ForEach(exercise.sortedMuscleWeights, id: \.muscle) { item in
                        HStack {
                            Text(item.muscle.displayName)
                            Spacer()
                            Text("\(Int(item.weight * 100))%")
                                .foregroundStyle(.secondary)
                            ProgressView(value: item.weight)
                                .frame(width: 60)
                        }
                    }
                }
            } header: {
                HStack {
                    Text("Muscle Activation")
                    Spacer()
                    if !exercise.isBuiltIn {
                        Button("Edit") {
                            showingMuscleEditor = true
                        }
                        .font(.caption)
                    }
                }
            }

            // Notes section
            if !exercise.notes.isEmpty {
                Section("Notes") {
                    Text(exercise.notes)
                        .font(.body)
                }
            }

            // Sources section
            if !exercise.sources.isEmpty {
                Section("Research Sources") {
                    ForEach(exercise.sources, id: \.self) { source in
                        Text(source)
                            .font(.caption)
                            .foregroundStyle(.secondary)
                    }
                }
            }

            // Timer settings section
            Section("Rest Timer") {
                LabeledContent("Rest Duration") {
                    Text(formatDuration(exercise.restDuration))
                }
                Toggle("Auto-start Timer", isOn: .constant(exercise.autoStartTimer))
                    .disabled(true)
            }
        }
        .navigationTitle(exercise.displayName)
        .navigationBarTitleDisplayMode(.large)
        .toolbar {
            ToolbarItem(placement: .primaryAction) {
                Button {
                    exercise.isFavorite.toggle()
                } label: {
                    Image(systemName: exercise.isFavorite ? "star.fill" : "star")
                }
            }
        }
        .sheet(isPresented: $showingMuscleEditor) {
            NavigationStack {
                MuscleWeightEditorView(exercise: exercise)
                    .navigationTitle("Edit Muscles")
                    .toolbar {
                        ToolbarItem(placement: .confirmationAction) {
                            Button("Done") {
                                showingMuscleEditor = false
                            }
                        }
                    }
            }
        }
    }

    /// Format dimension value for display (snake_case to Title Case)
    private func formatDimension(_ value: String) -> String {
        value.replacingOccurrences(of: "_", with: " ").capitalized
    }

    /// Format duration in seconds to readable string
    private func formatDuration(_ seconds: TimeInterval) -> String {
        let minutes = Int(seconds) / 60
        let secs = Int(seconds) % 60
        if secs == 0 {
            return "\(minutes) min"
        }
        return "\(minutes):\(String(format: "%02d", secs))"
    }
}

#Preview {
    NavigationStack {
        ExerciseDetailView(exercise: Exercise(displayName: "Test Exercise"))
    }
    .modelContainer(PersistenceController.preview)
}
```

Key changes:
1. Uses `exercise.displayName` directly
2. Shows `exercise.dimensions` values
3. Uses `exercise.sortedMuscleWeights` computed property
4. Shows `exercise.notes` and `exercise.sources`
5. Only allows muscle editing for non-builtin exercises
6. Removed all Variant references
  </action>
  <verify>
Build project - detail view should compile and show all exercise data.
  </verify>
  <done>
ExerciseDetailView updated to display new Exercise model fields.
  </done>
</task>

<task type="auto">
  <name>Task 4: Update ExercisePickerSheet</name>
  <files>
    GymAnals/Features/Workout/Views/ExercisePickerSheet.swift
  </files>
  <action>
Update ExercisePickerSheet to work with new Exercise model:
1. Search should use in-memory filtering for searchTerms
2. Display should use exercise.displayName
3. Remove any variant references

The exercise picker is used during workouts to add exercises. Ensure it:
- Searches by displayName, searchTerms, and movement name
- Shows equipment and category badges
- Returns the selected Exercise
  </action>
  <verify>
Build project - picker should compile. Test selecting exercises in workout.
  </verify>
  <done>
ExercisePickerSheet updated for new Exercise model.
  </done>
</task>

<task type="auto">
  <name>Task 5: Final cleanup and verification</name>
  <files>
    (search entire codebase)
  </files>
  <action>
Search entire codebase for any remaining references to Variant:

```bash
grep -r "\.variant" GymAnals/ --include="*.swift"
grep -r "Variant" GymAnals/ --include="*.swift" | grep -v "// Note" | grep -v "VariantMuscle was"
```

Fix any remaining references:
- `exercise.variant?.name` -> `exercise.displayName`
- `exercise.variant?.muscleWeights` -> `exercise.sortedMuscleWeights` or `exercise.muscleWeights`
- `variant.movement` -> `exercise.movement`

Also ensure:
- All files compile
- No SwiftData migration errors at runtime
- Exercise library displays 237 presets correctly
  </action>
  <verify>
Run full build and app launch. Verify exercise library shows seeded data.
  </verify>
  <done>
All Variant references removed. Exercise library fully functional with new model.
  </done>
</task>

</tasks>

<verification>
1. Run `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build` - exits with code 0
2. `grep -r "\.variant" GymAnals/ --include="*.swift"` returns no matches
3. Run app - exercise library shows 237+ exercises
4. Search works with exercise names and search terms
5. Exercise detail view shows all fields correctly
6. Exercise picker in workout flow works
</verification>

<success_criteria>
- All exercise library views compile without Variant references
- In-memory search filtering works for searchTerms
- Exercise detail shows dimensions, muscle weights, notes, sources
- Exercise picker selects exercises correctly for workouts
- 237 seeded exercises display in library
- Built-in exercises marked as read-only (edit muscles button hidden)
</success_criteria>

<output>
After completion, create `.planning/phases/05-exercise-library-rework/05-10-SUMMARY.md`
</output>
