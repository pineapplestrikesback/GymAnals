---
phase: 05-exercise-library-rework
plan: 07
type: execute
wave: 5
depends_on:
  - "06"
files_modified:
  - GymAnals/Services/Seed/MovementSeedService.swift
  - GymAnals/Services/Seed/EquipmentSeedService.swift
  - GymAnals/Services/Seed/PresetSeedService.swift
  - GymAnals/Services/Seed/SeedData.swift
autonomous: true

must_haves:
  truths:
    - "MovementSeedService can parse and seed movements.json"
    - "EquipmentSeedService can parse and seed equipment.json"
    - "PresetSeedService can parse and seed presets_all.json"
    - "All seed services use seedIfNeeded pattern"
    - "Muscle keys validated against Muscle enum at seed time"
  artifacts:
    - path: "GymAnals/Services/Seed/MovementSeedService.swift"
      provides: "Movement seeding from JSON"
      contains: "static func seedIfNeeded"
    - path: "GymAnals/Services/Seed/PresetSeedService.swift"
      provides: "Exercise preset seeding from JSON"
      contains: "static func seedIfNeeded"
  key_links:
    - from: "PresetSeedService.swift"
      to: "presets_all.json"
      via: "Bundle.main.url"
      pattern: "forResource.*presets_all"
---

<objective>
Create new seed services for movements, equipment, and exercise presets.

Purpose: Enable seeding 30 movements, 22 equipment types, and 237 exercise presets from JSON files.
Output: Three seed services ready to populate the database on first launch.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-exercise-library-rework/05-CONTEXT.md
@.planning/phases/05-exercise-library-rework/05-RESEARCH.md
@exercise_library_refactor/movements.json
@exercise_library_refactor/equipment.json
@exercise_library_refactor/presets_all.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SeedData.swift with new JSON structures</name>
  <files>
    GymAnals/Services/Seed/SeedData.swift
  </files>
  <action>
Replace SeedData.swift with new Decodable types matching the JSON files:

```swift
import Foundation

// MARK: - Equipment JSON Structure

struct EquipmentSeedData: Decodable {
    let equipment: [SeedEquipment]
}

struct SeedEquipment: Decodable {
    let id: String
    let displayName: String
    let category: String
    let properties: SeedEquipmentProperties
    let notes: String
}

struct SeedEquipmentProperties: Decodable {
    let bilateralOnly: Bool
    let resistanceCurve: String
    let stabilizationDemand: String
    let commonInGyms: Bool
}

// MARK: - Movement JSON Structure

struct MovementSeedData: Decodable {
    let movements: [SeedMovement]
}

struct SeedMovement: Decodable {
    let id: String
    let displayName: String
    let category: String
    let subcategory: String
    let applicableDimensions: SeedApplicableDimensions
    let applicableEquipment: [String]
    let defaultMuscleWeights: [String: Double]
    let defaultDescription: String
    let notes: String
    let sources: [String]
}

struct SeedApplicableDimensions: Decodable {
    let angle: [String]?
    let gripWidth: [String]?
    let gripOrientation: [String]?
    let stance: [String]?
    let laterality: [String]?

    /// Convert to dictionary format for Movement model
    func toDictionary() -> [String: [String]] {
        var result: [String: [String]] = [:]
        if let angle = angle { result["angle"] = angle }
        if let gripWidth = gripWidth { result["gripWidth"] = gripWidth }
        if let gripOrientation = gripOrientation { result["gripOrientation"] = gripOrientation }
        if let stance = stance { result["stance"] = stance }
        if let laterality = laterality { result["laterality"] = laterality }
        return result
    }
}

// MARK: - Preset JSON Structure

struct PresetSeedData: Decodable {
    let presets: [SeedPreset]
}

struct SeedPreset: Decodable {
    let id: String
    let displayName: String
    let searchTerms: [String]
    let movementID: String
    let dimensions: SeedDimensions
    let equipmentID: String
    let muscleWeights: [String: Double]
    let popularity: String
    let notes: String
    let sources: [String]
}

struct SeedDimensions: Decodable {
    let angle: String?
    let gripWidth: String?
    let gripOrientation: String?
    let stance: String?
    let laterality: String?
}
```
  </action>
  <verify>
Build project - SeedData.swift should compile without errors.
  </verify>
  <done>
SeedData.swift updated with all Decodable types matching movements.json, equipment.json, and presets_all.json structures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EquipmentSeedService</name>
  <files>
    GymAnals/Services/Seed/EquipmentSeedService.swift
  </files>
  <action>
Create EquipmentSeedService.swift:

```swift
import Foundation
import SwiftData

/// Service responsible for seeding equipment from equipment.json
@MainActor
final class EquipmentSeedService {

    /// Seeds the database with equipment if not already populated
    static func seedIfNeeded(context: ModelContext) {
        // Check if already seeded
        let descriptor = FetchDescriptor<Equipment>(
            predicate: #Predicate { $0.isBuiltIn == true }
        )
        let count = (try? context.fetchCount(descriptor)) ?? 0
        guard count == 0 else {
            return
        }

        // Load JSON from bundle
        guard let url = Bundle.main.url(forResource: "equipment", withExtension: "json"),
              let data = try? Data(contentsOf: url),
              let seedData = try? JSONDecoder().decode(EquipmentSeedData.self, from: data) else {
            print("EquipmentSeedService: Failed to load equipment.json from bundle")
            return
        }

        // Create Equipment entities
        for seed in seedData.equipment {
            let category = EquipmentCategory(rawValue: seed.category) ?? .free_weight

            let properties = EquipmentProperties(
                bilateralOnly: seed.properties.bilateralOnly,
                resistanceCurve: seed.properties.resistanceCurve,
                stabilizationDemand: seed.properties.stabilizationDemand,
                commonInGyms: seed.properties.commonInGyms
            )

            let equipment = Equipment(
                id: seed.id,
                displayName: seed.displayName,
                category: category,
                properties: properties,
                notes: seed.notes,
                isBuiltIn: true
            )

            context.insert(equipment)
        }

        do {
            try context.save()
            print("EquipmentSeedService: Seeded \(seedData.equipment.count) equipment types")
        } catch {
            print("EquipmentSeedService: Failed to save - \(error.localizedDescription)")
        }
    }
}
```
  </action>
  <verify>
Build project - EquipmentSeedService should compile.
  </verify>
  <done>
EquipmentSeedService created with seedIfNeeded pattern loading from equipment.json.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create MovementSeedService</name>
  <files>
    GymAnals/Services/Seed/MovementSeedService.swift
  </files>
  <action>
Create MovementSeedService.swift:

```swift
import Foundation
import SwiftData

/// Service responsible for seeding movements from movements.json
@MainActor
final class MovementSeedService {

    /// Seeds the database with movements if not already populated
    static func seedIfNeeded(context: ModelContext) {
        // Check if already seeded
        let descriptor = FetchDescriptor<Movement>(
            predicate: #Predicate { $0.isBuiltIn == true }
        )
        let count = (try? context.fetchCount(descriptor)) ?? 0
        guard count == 0 else {
            return
        }

        // Load JSON from bundle
        guard let url = Bundle.main.url(forResource: "movements", withExtension: "json"),
              let data = try? Data(contentsOf: url),
              let seedData = try? JSONDecoder().decode(MovementSeedData.self, from: data) else {
            print("MovementSeedService: Failed to load movements.json from bundle")
            return
        }

        // Create Movement entities
        for seed in seedData.movements {
            let category = MovementCategory(rawValue: seed.category) ?? .push

            // Validate muscle weight keys
            for key in seed.defaultMuscleWeights.keys {
                if Muscle(rawValue: key) == nil {
                    print("MovementSeedService: Warning - invalid muscle key '\(key)' in movement '\(seed.id)'")
                }
            }

            let movement = Movement(
                id: seed.id,
                displayName: seed.displayName,
                category: category,
                subcategory: seed.subcategory,
                isBuiltIn: true
            )
            movement.applicableDimensions = seed.applicableDimensions.toDictionary()
            movement.applicableEquipment = seed.applicableEquipment
            movement.defaultMuscleWeights = seed.defaultMuscleWeights
            movement.defaultDescription = seed.defaultDescription
            movement.notes = seed.notes
            movement.sources = seed.sources

            context.insert(movement)
        }

        do {
            try context.save()
            print("MovementSeedService: Seeded \(seedData.movements.count) movements")
        } catch {
            print("MovementSeedService: Failed to save - \(error.localizedDescription)")
        }
    }
}
```
  </action>
  <verify>
Build project - MovementSeedService should compile.
  </verify>
  <done>
MovementSeedService created with seedIfNeeded pattern loading from movements.json.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create PresetSeedService</name>
  <files>
    GymAnals/Services/Seed/PresetSeedService.swift
  </files>
  <action>
Create PresetSeedService.swift:

```swift
import Foundation
import SwiftData

/// Service responsible for seeding exercise presets from presets_all.json
@MainActor
final class PresetSeedService {

    /// Seeds the database with exercise presets if not already populated
    /// Must be called AFTER MovementSeedService and EquipmentSeedService
    static func seedIfNeeded(context: ModelContext) {
        // Check if already seeded
        let descriptor = FetchDescriptor<Exercise>(
            predicate: #Predicate { $0.isBuiltIn == true }
        )
        let count = (try? context.fetchCount(descriptor)) ?? 0
        guard count == 0 else {
            return
        }

        // Load JSON from bundle
        guard let url = Bundle.main.url(forResource: "presets_all", withExtension: "json"),
              let data = try? Data(contentsOf: url),
              let seedData = try? JSONDecoder().decode(PresetSeedData.self, from: data) else {
            print("PresetSeedService: Failed to load presets_all.json from bundle")
            return
        }

        // Fetch movements and equipment for relationship linking
        let movements = (try? context.fetch(FetchDescriptor<Movement>())) ?? []
        let equipment = (try? context.fetch(FetchDescriptor<Equipment>())) ?? []
        let movementMap = Dictionary(uniqueKeysWithValues: movements.map { ($0.id, $0) })
        let equipmentMap = Dictionary(uniqueKeysWithValues: equipment.map { ($0.id, $0) })

        var presetCount = 0
        var invalidMuscleKeys: Set<String> = []

        for seed in seedData.presets {
            // Validate muscle weight keys
            for key in seed.muscleWeights.keys {
                if Muscle(rawValue: key) == nil {
                    invalidMuscleKeys.insert(key)
                }
            }

            let dimensions = Dimensions(
                angle: seed.dimensions.angle,
                gripWidth: seed.dimensions.gripWidth,
                gripOrientation: seed.dimensions.gripOrientation,
                stance: seed.dimensions.stance,
                laterality: seed.dimensions.laterality
            )

            let popularity = Popularity(rawValue: seed.popularity) ?? .common

            let exercise = Exercise(
                id: seed.id,
                displayName: seed.displayName,
                movement: movementMap[seed.movementID],
                equipment: equipmentMap[seed.equipmentID],
                dimensions: dimensions,
                muscleWeights: seed.muscleWeights,
                popularity: popularity,
                isBuiltIn: true
            )
            exercise.searchTerms = seed.searchTerms
            exercise.notes = seed.notes
            exercise.sources = seed.sources

            context.insert(exercise)
            presetCount += 1
        }

        if !invalidMuscleKeys.isEmpty {
            print("PresetSeedService: Warning - invalid muscle keys found: \(invalidMuscleKeys.sorted())")
        }

        do {
            try context.save()
            print("PresetSeedService: Seeded \(presetCount) exercise presets")
        } catch {
            print("PresetSeedService: Failed to save - \(error.localizedDescription)")
        }
    }
}
```
  </action>
  <verify>
Build project - PresetSeedService should compile.
  </verify>
  <done>
PresetSeedService created with seedIfNeeded pattern loading from presets_all.json with muscle key validation.
  </done>
</task>

<task type="auto">
  <name>Task 5: Remove old ExerciseSeedService</name>
  <files>
    GymAnals/Services/Seed/ExerciseSeedService.swift
  </files>
  <action>
Delete the old ExerciseSeedService.swift file since it uses the deprecated Variant model.

The new seeding flow will be:
1. GymSeedService.seedIfNeeded() - create default gym
2. EquipmentSeedService.seedIfNeeded() - create 22 equipment types
3. MovementSeedService.seedIfNeeded() - create 30 movements
4. PresetSeedService.seedIfNeeded() - create 237 exercise presets

Also delete any old exercises.json file in Resources if it exists.
  </action>
  <verify>
Verify ExerciseSeedService.swift is deleted.
  </verify>
  <done>
Old ExerciseSeedService deleted. New seed services ready for use.
  </done>
</task>

</tasks>

<verification>
1. Run `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build` - exits with code 0
2. EquipmentSeedService.swift exists and contains "seedIfNeeded"
3. MovementSeedService.swift exists and contains "seedIfNeeded"
4. PresetSeedService.swift exists and contains "seedIfNeeded"
5. ExerciseSeedService.swift no longer exists
6. SeedData.swift contains PresetSeedData, MovementSeedData, EquipmentSeedData types
</verification>

<success_criteria>
- All three new seed services compile
- SeedData.swift has Decodable types matching JSON structures
- Muscle key validation present in PresetSeedService
- Old ExerciseSeedService deleted
- Services use seedIfNeeded pattern checking isBuiltIn count
</success_criteria>

<output>
After completion, create `.planning/phases/05-exercise-library-rework/05-07-SUMMARY.md`
</output>
