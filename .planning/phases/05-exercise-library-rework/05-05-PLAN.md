---
phase: 05-exercise-library-rework
plan: 05
type: execute
wave: 3
depends_on:
  - "01"
  - "02"
  - "03"
  - "04"
files_modified:
  - GymAnals/Models/Core/Exercise.swift
autonomous: true

must_haves:
  truths:
    - "Exercise model has id as String (not UUID)"
    - "Exercise model has displayName stored property"
    - "Exercise model has embedded Dimensions struct"
    - "Exercise model has muscleWeights dictionary (not VariantMuscle relationship)"
    - "Exercise model has direct movement relationship (not via Variant)"
    - "isUnilateral is computed from dimensions.laterality"
    - "Project compiles after Exercise update"
  artifacts:
    - path: "GymAnals/Models/Core/Exercise.swift"
      provides: "Refactored Exercise model with dimensions and muscleWeights"
      contains: "var dimensions: Dimensions"
  key_links:
    - from: "Exercise.swift"
      to: "Dimensions.swift"
      via: "embedded struct"
      pattern: "var dimensions: Dimensions"
    - from: "Exercise.swift"
      to: "Movement.swift"
      via: "direct relationship"
      pattern: "var movement: Movement?"
---

<objective>
Transform the Exercise model to use dimensions-based structure with embedded muscleWeights dictionary.

Purpose: Replace Variant-based model with the new preset schema supporting dimensions and direct muscle weights.
Output: Updated Exercise model matching presets_all.json structure.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-exercise-library-rework/05-CONTEXT.md
@.planning/phases/05-exercise-library-rework/05-RESEARCH.md
@GymAnals/Models/Core/Exercise.swift
@GymAnals/Models/Embedded/Dimensions.swift
@GymAnals/Models/Enums/Popularity.swift
@exercise_library_refactor/presets_all.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Exercise model with new schema</name>
  <files>
    GymAnals/Models/Core/Exercise.swift
  </files>
  <action>
Completely rewrite Exercise.swift to match the preset schema:

```swift
import Foundation
import SwiftData

/// A specific exercise with muscle targeting and variation dimensions
/// (e.g., "Barbell Incline Bench Press" with specific angle and grip)
@Model
final class Exercise {
    // MARK: - Identification

    /// Unique identifier - snake_case for presets (e.g., "barbell_flat_bench_press"), UUID string for custom
    var id: String = UUID().uuidString

    /// User-friendly display name (always stored, not computed)
    var displayName: String = ""

    /// Alternative names for search (e.g., ["bench press", "flat bench", "bb bench"])
    var searchTerms: [String] = []

    // MARK: - Classification

    /// Exercise variation dimensions (angle, grip, stance, etc.)
    var dimensions: Dimensions = Dimensions()

    /// Muscle activation weights (key: Muscle.rawValue, value: 0.0-1.0)
    var muscleWeights: [String: Double] = [:]

    /// Raw value storage for popularity
    var popularityRaw: String = Popularity.common.rawValue

    // MARK: - Metadata

    var notes: String = ""
    var sources: [String] = []
    var isBuiltIn: Bool = false

    // MARK: - App-Specific Fields

    var isFavorite: Bool = false
    var lastUsedDate: Date?

    /// Rest duration in seconds between sets for this exercise
    var restDuration: TimeInterval = 120  // Default 2 minutes

    /// Whether to auto-start timer when a set is completed
    var autoStartTimer: Bool = true

    // MARK: - Relationships

    /// The movement pattern this exercise belongs to (e.g., "Bench Press")
    var movement: Movement?

    /// Equipment used for this exercise (e.g., "Barbell")
    var equipment: Equipment?

    /// Gym where this exercise is tracked (for gym-specific weight history)
    var gym: Gym?

    @Relationship(deleteRule: .cascade, inverse: \WorkoutSet.exercise)
    var workoutSets: [WorkoutSet] = []

    @Relationship(deleteRule: .cascade, inverse: \ExerciseWeightHistory.exercise)
    var weightHistory: [ExerciseWeightHistory] = []

    // MARK: - Computed Properties

    /// Type-safe access to popularity
    var popularity: Popularity {
        get { Popularity(rawValue: popularityRaw) ?? .common }
        set { popularityRaw = newValue.rawValue }
    }

    /// Whether this is a unilateral exercise (derived from dimensions)
    var isUnilateral: Bool {
        dimensions.laterality == "unilateral"
    }

    /// Primary muscle group based on highest weighted muscle
    var primaryMuscleGroup: MuscleGroup? {
        guard let primaryMuscle = muscleWeights.max(by: { $0.value < $1.value }),
              let muscle = Muscle(rawValue: primaryMuscle.key) else {
            return nil
        }
        return muscle.group
    }

    /// Get weight for a specific muscle (type-safe helper)
    func weight(for muscle: Muscle) -> Double {
        muscleWeights[muscle.rawValue] ?? 0.0
    }

    /// Get all muscles with their weights, sorted by weight descending
    var sortedMuscleWeights: [(muscle: Muscle, weight: Double)] {
        muscleWeights.compactMap { key, value in
            guard let muscle = Muscle(rawValue: key) else { return nil }
            return (muscle, value)
        }.sorted { $0.weight > $1.weight }
    }

    // MARK: - Initialization

    init(
        id: String? = nil,
        displayName: String = "",
        movement: Movement? = nil,
        equipment: Equipment? = nil,
        dimensions: Dimensions = Dimensions(),
        muscleWeights: [String: Double] = [:],
        popularity: Popularity = .common,
        isBuiltIn: Bool = false
    ) {
        self.id = id ?? UUID().uuidString
        self.displayName = displayName
        self.movement = movement
        self.equipment = equipment
        self.dimensions = dimensions
        self.muscleWeights = muscleWeights
        self.popularityRaw = popularity.rawValue
        self.isBuiltIn = isBuiltIn
    }

    /// Create a custom exercise inheriting defaults from movement
    static func custom(
        displayName: String,
        movement: Movement,
        equipment: Equipment?,
        dimensions: Dimensions = Dimensions()
    ) -> Exercise {
        let exercise = Exercise(
            displayName: displayName,
            movement: movement,
            equipment: equipment,
            dimensions: dimensions,
            muscleWeights: movement.defaultMuscleWeights,
            isBuiltIn: false
        )
        return exercise
    }
}
```

Key changes from old model:
1. Changed `id` from UUID to String (for snake_case preset IDs)
2. Added `displayName` as stored property (was computed from variant)
3. Added `searchTerms: [String]` array for search
4. Added `dimensions: Dimensions` embedded struct (replaces variant reference)
5. Added `muscleWeights: [String: Double]` dictionary (replaces VariantMuscle relationship)
6. Added `popularityRaw` with computed `popularity` accessor
7. Added `notes` and `sources` fields
8. REMOVED `variant` relationship (replaced by dimensions)
9. ADDED direct `movement` relationship
10. Changed `isUnilateral` from stored to computed (from dimensions.laterality)
11. Added helper methods: `weight(for:)`, `sortedMuscleWeights`, `primaryMuscleGroup`
12. Added static factory `custom(displayName:movement:equipment:dimensions:)` for creating custom exercises
  </action>
  <verify>
Build project - should compile after this change. Verify relationships compile correctly with Movement and Equipment.
  </verify>
  <done>
Exercise model completely rewritten with dimensions, muscleWeights dictionary, and direct movement relationship. Variant reference removed.
  </done>
</task>

</tasks>

<verification>
1. Run `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build` - exits with code 0
2. Exercise.swift contains "var id: String"
3. Exercise.swift contains "var dimensions: Dimensions"
4. Exercise.swift contains "var muscleWeights: [String: Double]"
5. Exercise.swift contains "var movement: Movement?"
6. Exercise.swift does NOT contain "var variant: Variant?"
7. Exercise.swift contains "var isUnilateral: Bool" as computed property
8. Exercise.swift contains "func weight(for muscle: Muscle)"
</verification>

<success_criteria>
- Exercise model compiles with all new properties
- String-based id allows snake_case identifiers for presets
- Dimensions embedded struct replaces Variant reference
- muscleWeights dictionary replaces VariantMuscle relationship
- Direct movement relationship established
- isUnilateral computed from dimensions.laterality
- Helper methods for type-safe muscle weight access
- Static factory for creating custom exercises with inherited defaults
</success_criteria>

<output>
After completion, create `.planning/phases/05-exercise-library-rework/05-05-SUMMARY.md`
</output>
