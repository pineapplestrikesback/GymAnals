---
phase: 05-exercise-library-rework
plan: 09
type: execute
wave: 6
depends_on:
  - "08"
files_modified:
  - GymAnals/Features/ExerciseLibrary/ViewModels/ExerciseCreationViewModel.swift
  - GymAnals/Features/ExerciseLibrary/Views/ExerciseCreationWizard.swift
  - GymAnals/Features/ExerciseLibrary/Views/WizardSteps/VariationStepView.swift
  - GymAnals/Features/ExerciseLibrary/Views/WizardSteps/MovementStepView.swift
  - GymAnals/Features/ExerciseLibrary/Views/WizardSteps/EquipmentStepView.swift
  - GymAnals/Features/ExerciseLibrary/ViewModels/MuscleWeightViewModel.swift
  - GymAnals/Features/ExerciseLibrary/Views/MuscleWeightEditorView.swift
autonomous: true

must_haves:
  truths:
    - "Exercise creation wizard creates Exercise with dimensions, not Variant"
    - "Custom exercises inherit defaultMuscleWeights from Movement"
    - "No references to Variant model in wizard"
    - "MuscleWeightEditorView works with Exercise.muscleWeights dictionary"
    - "Project compiles and wizard functions"
  artifacts:
    - path: "GymAnals/Features/ExerciseLibrary/ViewModels/ExerciseCreationViewModel.swift"
      provides: "Updated wizard ViewModel"
      contains: "Exercise.custom"
  key_links:
    - from: "ExerciseCreationViewModel.swift"
      to: "Exercise.swift"
      via: "Exercise.custom factory"
      pattern: "Exercise.custom"
---

<objective>
Update the exercise creation wizard to work with the new dimensions-based model.

Purpose: Enable users to create custom exercises using the new schema (Movement + Equipment + Dimensions).
Output: Working exercise creation wizard without Variant dependency.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-exercise-library-rework/05-CONTEXT.md
@GymAnals/Features/ExerciseLibrary/ViewModels/ExerciseCreationViewModel.swift
@GymAnals/Features/ExerciseLibrary/Views/ExerciseCreationWizard.swift
@GymAnals/Models/Core/Exercise.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ExerciseCreationViewModel</name>
  <files>
    GymAnals/Features/ExerciseLibrary/ViewModels/ExerciseCreationViewModel.swift
  </files>
  <action>
Rewrite ExerciseCreationViewModel to work with the new model:

```swift
import Foundation
import SwiftData

/// ViewModel managing the exercise creation wizard state
@Observable
final class ExerciseCreationViewModel {
    // MARK: - Wizard Step Tracking

    var currentStep: Int = 0
    let steps = ["Movement", "Name", "Equipment", "Type", "Muscles"]

    // MARK: - Step 1: Movement

    var selectedMovement: Movement?
    var newMovementName: String = ""
    var isCreatingNewMovement: Bool = false

    // MARK: - Step 2: Exercise Name (replaces Variation step)

    var exerciseName: String = ""

    // MARK: - Step 3: Equipment

    var selectedEquipment: Equipment?

    // MARK: - Step 4: Exercise Type

    var selectedExerciseType: ExerciseType = .weightReps

    // MARK: - Step 5: Dimensions (optional, simplified)

    var dimensions: Dimensions = Dimensions()

    // MARK: - Created Entity

    var createdExercise: Exercise?

    // MARK: - Validation

    var canProceed: Bool {
        switch currentStep {
        case 0: return selectedMovement != nil || !newMovementName.isEmpty
        case 1: return !exerciseName.isEmpty
        case 2: return selectedEquipment != nil
        case 3: return true // Type always has default
        case 4: return true // Muscles can use defaults
        default: return false
        }
    }

    var isLastStep: Bool {
        currentStep == steps.count - 1
    }

    // MARK: - Navigation

    func nextStep() {
        if currentStep < steps.count - 1 {
            currentStep += 1
        }
    }

    func previousStep() {
        if currentStep > 0 {
            currentStep -= 1
        }
    }

    // MARK: - Exercise Creation

    func createExercise(context: ModelContext) -> Exercise? {
        // Get or create movement
        let movement: Movement
        if let existing = selectedMovement {
            movement = existing
        } else {
            movement = Movement(
                displayName: newMovementName,
                exerciseType: selectedExerciseType,
                isBuiltIn: false
            )
            context.insert(movement)
        }

        // Create exercise using factory method (inherits defaultMuscleWeights)
        let exercise = Exercise.custom(
            displayName: exerciseName,
            movement: movement,
            equipment: selectedEquipment,
            dimensions: dimensions
        )
        context.insert(exercise)
        createdExercise = exercise

        try? context.save()
        return exercise
    }

    // MARK: - Reset

    func reset() {
        currentStep = 0
        selectedMovement = nil
        newMovementName = ""
        isCreatingNewMovement = false
        exerciseName = ""
        selectedEquipment = nil
        selectedExerciseType = .weightReps
        dimensions = Dimensions()
        createdExercise = nil
    }

    // MARK: - Suggested Name

    /// Generates a suggested exercise name based on selections
    var suggestedName: String {
        var parts: [String] = []

        if let equipment = selectedEquipment {
            parts.append(equipment.displayName)
        }

        if let movement = selectedMovement {
            parts.append(movement.displayName)
        } else if !newMovementName.isEmpty {
            parts.append(newMovementName)
        }

        return parts.joined(separator: " ")
    }
}
```

Key changes:
1. Removed `variationName` - replaced with `exerciseName`
2. Removed `createdVariant` - no longer creating Variant
3. Added `dimensions: Dimensions` property
4. Changed `createExercise` to use `Exercise.custom()` factory
5. Step 2 changed from "Variation" to "Name"
6. Added `suggestedName` helper
  </action>
  <verify>
Build project - ViewModel should compile.
  </verify>
  <done>
ExerciseCreationViewModel updated to create Exercise directly without Variant.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ExerciseCreationWizard</name>
  <files>
    GymAnals/Features/ExerciseLibrary/Views/ExerciseCreationWizard.swift
  </files>
  <action>
Update ExerciseCreationWizard.swift to work with the new ViewModel:

```swift
import SwiftUI
import SwiftData

/// Multi-step wizard for creating custom exercises
struct ExerciseCreationWizard: View {
    @Environment(\.modelContext) private var modelContext
    @Environment(\.dismiss) private var dismiss

    @State private var viewModel = ExerciseCreationViewModel()

    var body: some View {
        NavigationStack {
            VStack(spacing: 0) {
                // Progress dots
                HStack(spacing: 8) {
                    ForEach(0..<viewModel.steps.count, id: \.self) { index in
                        Circle()
                            .fill(index <= viewModel.currentStep ? Color.accentColor : Color.secondary.opacity(0.3))
                            .frame(width: 8, height: 8)
                    }
                }
                .padding(.vertical, 12)

                // Step label
                Text(viewModel.steps[viewModel.currentStep])
                    .font(.caption)
                    .foregroundStyle(.secondary)
                    .padding(.bottom, 8)

                Divider()

                // Step content
                Group {
                    switch viewModel.currentStep {
                    case 0:
                        MovementStepView(viewModel: viewModel)
                    case 1:
                        ExerciseNameStepView(viewModel: viewModel)
                    case 2:
                        EquipmentStepView(viewModel: viewModel)
                    case 3:
                        ExerciseTypeStepView(viewModel: viewModel)
                    case 4:
                        // Final step: create and show muscle editor
                        if let exercise = viewModel.createdExercise {
                            MuscleWeightEditorView(exercise: exercise)
                        } else {
                            ProgressView("Creating exercise...")
                                .onAppear {
                                    _ = viewModel.createExercise(context: modelContext)
                                }
                        }
                    default:
                        EmptyView()
                    }
                }
                .frame(maxHeight: .infinity)

                Divider()

                // Navigation buttons
                HStack {
                    if viewModel.currentStep > 0 {
                        Button("Back") {
                            viewModel.previousStep()
                        }
                        .buttonStyle(.bordered)
                    }

                    Spacer()

                    if viewModel.currentStep < viewModel.steps.count - 1 {
                        Button("Next") {
                            viewModel.nextStep()
                        }
                        .buttonStyle(.borderedProminent)
                        .disabled(!viewModel.canProceed)
                    } else {
                        Button("Done") {
                            dismiss()
                        }
                        .buttonStyle(.borderedProminent)
                    }
                }
                .padding()
            }
            .navigationTitle("New Exercise")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("Cancel") {
                        dismiss()
                    }
                }
            }
        }
    }
}

#Preview {
    ExerciseCreationWizard()
        .modelContainer(PersistenceController.preview)
}
```

Key changes:
1. Step 1 (case 1) now uses `ExerciseNameStepView` instead of `VariationStepView`
2. Step 4 (muscles) passes `exercise` to `MuscleWeightEditorView` instead of `variant`
  </action>
  <verify>
Build project - wizard should compile.
  </verify>
  <done>
ExerciseCreationWizard updated to use new step views.
  </done>
</task>

<task type="auto">
  <name>Task 3: Replace VariationStepView with ExerciseNameStepView</name>
  <files>
    GymAnals/Features/ExerciseLibrary/Views/WizardSteps/VariationStepView.swift
  </files>
  <action>
Replace VariationStepView.swift content with ExerciseNameStepView (or rename file):

```swift
import SwiftUI

/// Step 2: Enter exercise name
struct ExerciseNameStepView: View {
    @Bindable var viewModel: ExerciseCreationViewModel

    var body: some View {
        Form {
            Section {
                TextField("Exercise Name", text: $viewModel.exerciseName)
                    .textInputAutocapitalization(.words)
            } header: {
                Text("Name")
            } footer: {
                Text("Enter a descriptive name for your exercise.")
            }

            if !viewModel.suggestedName.isEmpty && viewModel.exerciseName.isEmpty {
                Section {
                    Button {
                        viewModel.exerciseName = viewModel.suggestedName
                    } label: {
                        HStack {
                            Text("Use suggested name:")
                            Spacer()
                            Text(viewModel.suggestedName)
                                .foregroundStyle(.secondary)
                        }
                    }
                } header: {
                    Text("Suggestion")
                }
            }
        }
    }
}

#Preview {
    ExerciseNameStepView(viewModel: ExerciseCreationViewModel())
}
```

If renaming the file, rename from VariationStepView.swift to ExerciseNameStepView.swift.
  </action>
  <verify>
Build project - step view should compile.
  </verify>
  <done>
ExerciseNameStepView created (replaces VariationStepView).
  </done>
</task>

<task type="auto">
  <name>Task 4: Update MuscleWeightViewModel and EditorView</name>
  <files>
    GymAnals/Features/ExerciseLibrary/ViewModels/MuscleWeightViewModel.swift
    GymAnals/Features/ExerciseLibrary/Views/MuscleWeightEditorView.swift
  </files>
  <action>
Update MuscleWeightViewModel to work with Exercise instead of Variant:

```swift
import Foundation
import SwiftData

/// ViewModel for editing muscle weights on an Exercise
@Observable
final class MuscleWeightViewModel {
    let exercise: Exercise

    /// Muscle weights as array of (Muscle, Double) for UI binding
    var weights: [(muscle: Muscle, weight: Double)] = []

    init(exercise: Exercise) {
        self.exercise = exercise
        loadWeights()
    }

    private func loadWeights() {
        // Initialize with all muscles, using existing weights or 0
        weights = Muscle.allCases.map { muscle in
            (muscle, exercise.muscleWeights[muscle.rawValue] ?? 0.0)
        }
    }

    func updateWeight(for muscle: Muscle, to weight: Double) {
        // Update local array
        if let index = weights.firstIndex(where: { $0.muscle == muscle }) {
            weights[index].weight = max(0.0, min(1.0, weight))
        }

        // Update exercise dictionary
        let clampedWeight = max(0.0, min(1.0, weight))
        if clampedWeight > 0 {
            exercise.muscleWeights[muscle.rawValue] = clampedWeight
        } else {
            exercise.muscleWeights.removeValue(forKey: muscle.rawValue)
        }
    }

    func weight(for muscle: Muscle) -> Double {
        weights.first(where: { $0.muscle == muscle })?.weight ?? 0.0
    }

    /// Muscles with non-zero weight, sorted by weight
    var activeMuscles: [(muscle: Muscle, weight: Double)] {
        weights.filter { $0.weight > 0 }.sorted { $0.weight > $1.weight }
    }
}
```

Update MuscleWeightEditorView to accept Exercise:

```swift
import SwiftUI

/// View for editing muscle contribution weights on an exercise
struct MuscleWeightEditorView: View {
    @State private var viewModel: MuscleWeightViewModel
    @State private var selectedGroup: MuscleGroup? = nil

    init(exercise: Exercise) {
        _viewModel = State(initialValue: MuscleWeightViewModel(exercise: exercise))
    }

    var body: some View {
        List {
            // Show active muscles summary
            if !viewModel.activeMuscles.isEmpty {
                Section("Active Muscles") {
                    ForEach(viewModel.activeMuscles, id: \.muscle) { item in
                        HStack {
                            Text(item.muscle.displayName)
                            Spacer()
                            Text("\(Int(item.weight * 100))%")
                                .foregroundStyle(.secondary)
                        }
                    }
                }
            }

            // Muscle group picker
            Section("Add Muscles") {
                Picker("Muscle Group", selection: $selectedGroup) {
                    Text("Select Group").tag(nil as MuscleGroup?)
                    ForEach(MuscleGroup.allCases) { group in
                        Text(group.displayName).tag(group as MuscleGroup?)
                    }
                }
            }

            // Muscles in selected group
            if let group = selectedGroup {
                Section(group.displayName) {
                    ForEach(Muscle.allCases.filter { $0.group == group }) { muscle in
                        MuscleSlider(
                            muscle: muscle,
                            weight: viewModel.weight(for: muscle),
                            onWeightChanged: { newWeight in
                                viewModel.updateWeight(for: muscle, to: newWeight)
                            }
                        )
                    }
                }
            }
        }
    }
}

#Preview {
    MuscleWeightEditorView(exercise: Exercise(displayName: "Test Exercise"))
        .modelContainer(PersistenceController.preview)
}
```
  </action>
  <verify>
Build project - MuscleWeightViewModel and MuscleWeightEditorView should compile.
  </verify>
  <done>
MuscleWeightViewModel and EditorView updated to work with Exercise.muscleWeights dictionary.
  </done>
</task>

<task type="auto">
  <name>Task 5: Update MovementStepView if needed</name>
  <files>
    GymAnals/Features/ExerciseLibrary/Views/WizardSteps/MovementStepView.swift
  </files>
  <action>
Review MovementStepView and update if needed. The view should:
1. Allow selecting from existing Movement entities
2. Allow creating a new Movement with a name
3. Work with the updated ExerciseCreationViewModel

If the view uses `movement.variants` anywhere, remove that reference.
If the view already works with `viewModel.selectedMovement` and `viewModel.newMovementName`, no changes needed.
  </action>
  <verify>
Build project - MovementStepView should compile without Variant references.
  </verify>
  <done>
MovementStepView verified/updated to work without Variant references.
  </done>
</task>

</tasks>

<verification>
1. Run `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build` - exits with code 0
2. No files reference Variant or VariantMuscle types
3. ExerciseCreationViewModel uses Exercise.custom() factory
4. MuscleWeightEditorView accepts Exercise parameter
5. Run app and test exercise creation wizard flow
</verification>

<success_criteria>
- All wizard views compile without Variant references
- Custom exercise creation works end-to-end
- Muscle weights can be edited on newly created exercises
- Created exercises have muscleWeights inherited from Movement.defaultMuscleWeights
- Wizard flow completes without crashes
</success_criteria>

<output>
After completion, create `.planning/phases/05-exercise-library-rework/05-09-SUMMARY.md`
</output>
