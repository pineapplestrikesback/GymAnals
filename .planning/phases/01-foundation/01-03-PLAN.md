---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - GymAnals/Services/Persistence/PersistenceController.swift
  - GymAnals/App/GymAnalsApp.swift
autonomous: true

must_haves:
  truths:
    - "App launches with SwiftData ModelContainer initialized"
    - "Data can be saved and persists across app restarts"
    - "ModelContext is available to views via environment"
  artifacts:
    - path: "GymAnals/Services/Persistence/PersistenceController.swift"
      provides: "ModelContainer factory with schema"
      contains: "ModelContainer"
    - path: "GymAnals/App/GymAnalsApp.swift"
      provides: "App entry point with persistence"
      contains: ".modelContainer"
  key_links:
    - from: "GymAnalsApp.swift"
      to: "PersistenceController.swift"
      via: "container creation"
      pattern: "PersistenceController"
    - from: "PersistenceController.swift"
      to: "Movement.swift"
      via: "Schema registration"
      pattern: "Movement.self"
---

<objective>
Configure SwiftData persistence with ModelContainer and inject into app environment.

Purpose: Enable data persistence so models can be saved and retrieved offline.
Output: Working SwiftData stack with ModelContainer available to all views.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PersistenceController with ModelContainer</name>
  <files>
    GymAnals/Services/Persistence/PersistenceController.swift
  </files>
  <action>
Create folder structure GymAnals/Services/Persistence/ first.

Create PersistenceController.swift:
```swift
import Foundation
import SwiftData

@MainActor
final class PersistenceController {
    static let shared = PersistenceController()

    let schema: Schema
    let modelConfiguration: ModelConfiguration

    private init() {
        schema = Schema([
            Movement.self,
            Variant.self,
            VariantMuscle.self,
            Equipment.self,
            Exercise.self,
            Gym.self,
            Workout.self,
            WorkoutSet.self,
            ExerciseWeightHistory.self
        ])

        // User data stored in app's Documents directory
        let storeURL = URL.applicationSupportDirectory
            .appending(path: "GymAnals")
            .appending(path: "userdata.store")

        modelConfiguration = ModelConfiguration(
            "GymAnals",
            schema: schema,
            url: storeURL,
            allowsSave: true
        )
    }

    func createContainer() throws -> ModelContainer {
        // Ensure directory exists
        let directory = URL.applicationSupportDirectory.appending(path: "GymAnals")
        try FileManager.default.createDirectory(
            at: directory,
            withIntermediateDirectories: true
        )

        return try ModelContainer(
            for: schema,
            configurations: modelConfiguration
        )
    }

    /// For SwiftUI previews - uses in-memory storage
    static var preview: ModelContainer {
        let schema = Schema([
            Movement.self,
            Variant.self,
            VariantMuscle.self,
            Equipment.self,
            Exercise.self,
            Gym.self,
            Workout.self,
            WorkoutSet.self,
            ExerciseWeightHistory.self
        ])

        let config = ModelConfiguration(isStoredInMemoryOnly: true)

        do {
            return try ModelContainer(for: schema, configurations: config)
        } catch {
            fatalError("Failed to create preview container: \(error)")
        }
    }
}
```

IMPORTANT:
- Use @MainActor for thread safety
- Use URL.applicationSupportDirectory (not Documents) for database files
- Create directory before attempting to create container
- Include ALL @Model types in schema
- Provide preview container for SwiftUI previews
  </action>
  <verify>
Build project - should compile with no errors. Check that all model types are imported correctly.
  </verify>
  <done>
PersistenceController exists with createContainer() method returning configured ModelContainer.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate SwiftData into app lifecycle</name>
  <files>
    GymAnals/App/GymAnalsApp.swift
  </files>
  <action>
Update GymAnalsApp.swift to initialize and inject ModelContainer:

```swift
import SwiftUI
import SwiftData

@main
struct GymAnalsApp: App {
    let container: ModelContainer

    init() {
        do {
            container = try PersistenceController.shared.createContainer()
        } catch {
            fatalError("Failed to initialize SwiftData: \(error.localizedDescription)")
        }
    }

    var body: some Scene {
        WindowGroup {
            ContentView()
        }
        .modelContainer(container)
    }
}
```

IMPORTANT:
- Import SwiftData
- Initialize container in init() with error handling
- Use .modelContainer() scene modifier to inject into environment
- fatalError is acceptable for init failure (app can't function without persistence)
  </action>
  <verify>
1. Build and run app on simulator
2. App should launch without crash
3. Check console for any SwiftData warnings or errors
4. Verify app persists state by creating a simple test:
   - In debug, add a test to create and fetch a Gym object
   - Or verify container initializes by checking no fatalError occurs
  </verify>
  <done>
App launches with SwiftData ModelContainer. Container is injected into SwiftUI environment via .modelContainer modifier.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update previews to use preview container</name>
  <files>
    GymAnals/ContentView.swift
    GymAnals/Features/Workout/Views/WorkoutTabView.swift
    GymAnals/Features/Dashboard/Views/DashboardTabView.swift
    GymAnals/Features/Settings/Views/SettingsTabView.swift
  </files>
  <action>
Update each preview to use the preview ModelContainer so Xcode previews work correctly.

For ContentView.swift, update the preview:
```swift
#Preview {
    ContentView()
        .modelContainer(PersistenceController.preview)
}
```

For WorkoutTabView.swift, update the preview:
```swift
#Preview {
    WorkoutTabView()
        .modelContainer(PersistenceController.preview)
}
```

For DashboardTabView.swift, update the preview:
```swift
#Preview {
    DashboardTabView()
        .modelContainer(PersistenceController.preview)
}
```

For SettingsTabView.swift, update the preview:
```swift
#Preview {
    SettingsTabView()
        .modelContainer(PersistenceController.preview)
}
```

This ensures Xcode previews work without trying to access the real database.
  </action>
  <verify>
1. Open each view file in Xcode
2. Preview should render without errors
3. No "missing environment" or "container not found" errors in preview
  </verify>
  <done>
All view previews render correctly with preview ModelContainer.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build` succeeds
2. App launches on simulator without crash
3. No SwiftData errors in console
4. Xcode previews work for all views
5. Verify persistence by checking that userdata.store is created in Application Support after first launch
</verification>

<success_criteria>
- SwiftData ModelContainer initializes successfully on app launch
- All @Model types are registered in schema
- Container uses local file storage (not in-memory)
- Views receive ModelContext through environment
- Previews work with in-memory preview container
- App works fully offline (no network requirements)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
