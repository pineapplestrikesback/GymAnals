---
phase: 02-exercise-library
plan: 05
type: execute
wave: 3
depends_on: ["02-01", "02-03", "02-04"]
files_modified:
  - GymAnals/Features/ExerciseLibrary/Views/ExerciseCreationWizard.swift
  - GymAnals/Features/ExerciseLibrary/Views/WizardSteps/MovementStepView.swift
  - GymAnals/Features/ExerciseLibrary/Views/WizardSteps/VariationStepView.swift
  - GymAnals/Features/ExerciseLibrary/Views/WizardSteps/EquipmentStepView.swift
  - GymAnals/Features/ExerciseLibrary/Views/WizardSteps/ExerciseTypeStepView.swift
  - GymAnals/Features/ExerciseLibrary/ViewModels/ExerciseCreationViewModel.swift
  - GymAnals/Features/ExerciseLibrary/Views/ExerciseLibraryView.swift
autonomous: true

must_haves:
  truths:
    - "User can create a custom exercise through a guided wizard"
    - "User can select or create a new movement"
    - "User can select equipment for the exercise"
    - "User can set exercise type for logging field selection"
    - "Wizard flows to muscle weight editor as final step"
    - "Created exercise appears in library"
  artifacts:
    - path: "GymAnals/Features/ExerciseLibrary/Views/ExerciseCreationWizard.swift"
      provides: "Multi-step wizard container with progress dots"
      contains: "struct ExerciseCreationWizard"
    - path: "GymAnals/Features/ExerciseLibrary/ViewModels/ExerciseCreationViewModel.swift"
      provides: "Wizard state management"
      contains: "selectedMovement"
    - path: "GymAnals/Features/ExerciseLibrary/Views/WizardSteps/MovementStepView.swift"
      provides: "Movement selection/creation step"
      contains: "struct MovementStepView"
  key_links:
    - from: "ExerciseLibraryView.swift"
      to: "ExerciseCreationWizard.swift"
      via: "toolbar + button navigation"
      pattern: "ExerciseCreationWizard"
    - from: "ExerciseCreationWizard.swift"
      to: "MuscleWeightEditorView.swift"
      via: "final step navigation"
      pattern: "MuscleWeightEditorView"
    - from: "ExerciseCreationViewModel.swift"
      to: "Exercise model"
      via: "ModelContext for creation"
      pattern: "context.insert.*Exercise"
---

<objective>
Create a guided exercise creation wizard with progress dots and step-by-step flow.

Purpose: Deliver EXER-02 (user can create custom exercises) with a friendly wizard UX
Output: Multi-step wizard (Movement -> Variation -> Equipment -> Type -> Muscles) accessible from library toolbar
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-exercise-library/02-CONTEXT.md
@.planning/phases/02-exercise-library/02-RESEARCH.md
@.planning/phases/02-exercise-library/02-01-SUMMARY.md
@.planning/phases/02-exercise-library/02-03-SUMMARY.md
@.planning/phases/02-exercise-library/02-04-SUMMARY.md

@GymAnals/Models/Core/Movement.swift
@GymAnals/Models/Core/Variant.swift
@GymAnals/Models/Core/Equipment.swift
@GymAnals/Models/Core/Exercise.swift
@GymAnals/Features/ExerciseLibrary/Views/ExerciseLibraryView.swift
@GymAnals/Features/ExerciseLibrary/Views/MuscleWeightEditorView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExerciseCreationViewModel</name>
  <files>GymAnals/Features/ExerciseLibrary/ViewModels/ExerciseCreationViewModel.swift</files>
  <action>
Create ViewModel to manage wizard state:

```swift
import Foundation
import SwiftData

@Observable
final class ExerciseCreationViewModel {
    // Wizard step tracking
    var currentStep: Int = 0
    let steps = ["Movement", "Variation", "Equipment", "Type", "Muscles"]

    // Step 1: Movement
    var selectedMovement: Movement?
    var newMovementName: String = ""
    var isCreatingNewMovement: Bool = false

    // Step 2: Variation
    var variationName: String = ""

    // Step 3: Equipment
    var selectedEquipment: Equipment?

    // Step 4: Exercise Type
    var selectedExerciseType: ExerciseType = .weightReps

    // Created entities
    var createdVariant: Variant?
    var createdExercise: Exercise?

    var canProceed: Bool {
        switch currentStep {
        case 0: return selectedMovement != nil || !newMovementName.isEmpty
        case 1: return !variationName.isEmpty
        case 2: return selectedEquipment != nil
        case 3: return true // Type always has default
        case 4: return true // Muscles can be empty (with warning)
        default: return false
        }
    }

    var isLastStep: Bool {
        currentStep == steps.count - 1
    }

    func nextStep() {
        if currentStep < steps.count - 1 {
            currentStep += 1
        }
    }

    func previousStep() {
        if currentStep > 0 {
            currentStep -= 1
        }
    }

    func createExercise(context: ModelContext) -> Exercise? {
        // Get or create movement
        let movement: Movement
        if let existing = selectedMovement {
            movement = existing
        } else {
            movement = Movement(name: newMovementName, isBuiltIn: false)
            movement.exerciseTypeRaw = selectedExerciseType.rawValue
            context.insert(movement)
        }

        // Create variant
        let variant = Variant(name: variationName, isBuiltIn: false)
        variant.movement = movement
        context.insert(variant)
        createdVariant = variant

        // Create exercise with equipment
        let exercise = Exercise(variant: variant, equipment: selectedEquipment)
        context.insert(exercise)
        createdExercise = exercise

        try? context.save()
        return exercise
    }

    func reset() {
        currentStep = 0
        selectedMovement = nil
        newMovementName = ""
        isCreatingNewMovement = false
        variationName = ""
        selectedEquipment = nil
        selectedExerciseType = .weightReps
        createdVariant = nil
        createdExercise = nil
    }
}
```
  </action>
  <verify>Build succeeds</verify>
  <done>ExerciseCreationViewModel manages all wizard state and can create exercise at completion</done>
</task>

<task type="auto">
  <name>Task 2: Create wizard step views</name>
  <files>GymAnals/Features/ExerciseLibrary/Views/WizardSteps/MovementStepView.swift, GymAnals/Features/ExerciseLibrary/Views/WizardSteps/VariationStepView.swift, GymAnals/Features/ExerciseLibrary/Views/WizardSteps/EquipmentStepView.swift, GymAnals/Features/ExerciseLibrary/Views/WizardSteps/ExerciseTypeStepView.swift</files>
  <action>
Create the WizardSteps folder and step views:

**MovementStepView.swift:**
```swift
import SwiftUI
import SwiftData

struct MovementStepView: View {
    @Bindable var viewModel: ExerciseCreationViewModel
    @Query(sort: \Movement.name) private var movements: [Movement]
    @State private var searchText = ""

    var filteredMovements: [Movement] {
        if searchText.isEmpty {
            return movements
        }
        return movements.filter { $0.name.localizedCaseInsensitiveContains(searchText) }
    }

    var body: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("Select or create a movement")
                .font(.headline)

            TextField("Search movements", text: $searchText)
                .textFieldStyle(.roundedBorder)

            if filteredMovements.isEmpty && !searchText.isEmpty {
                Button {
                    viewModel.newMovementName = searchText
                    viewModel.isCreatingNewMovement = true
                    viewModel.selectedMovement = nil
                } label: {
                    Label("Create \"\(searchText)\"", systemImage: "plus.circle.fill")
                }
                .buttonStyle(.borderedProminent)
            }

            List(filteredMovements, selection: $viewModel.selectedMovement) { movement in
                HStack {
                    Text(movement.name)
                    Spacer()
                    if viewModel.selectedMovement?.id == movement.id {
                        Image(systemName: "checkmark")
                            .foregroundStyle(.accent)
                    }
                }
                .contentShape(Rectangle())
                .onTapGesture {
                    viewModel.selectedMovement = movement
                    viewModel.isCreatingNewMovement = false
                    viewModel.newMovementName = ""
                }
            }
            .listStyle(.plain)

            if viewModel.isCreatingNewMovement {
                HStack {
                    Image(systemName: "sparkles")
                    Text("Creating new: \(viewModel.newMovementName)")
                }
                .foregroundStyle(.secondary)
                .font(.caption)
            }
        }
        .padding()
    }
}
```

**VariationStepView.swift:**
```swift
import SwiftUI

struct VariationStepView: View {
    @Bindable var viewModel: ExerciseCreationViewModel

    // Common variation suggestions
    let suggestions = ["Standard", "Incline", "Decline", "Wide Grip", "Close Grip", "Neutral Grip", "Reverse Grip", "Single Arm", "Seated", "Standing"]

    var body: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("Name this variation")
                .font(.headline)

            TextField("e.g., Incline, Wide Grip", text: $viewModel.variationName)
                .textFieldStyle(.roundedBorder)

            Text("Suggestions")
                .font(.subheadline)
                .foregroundStyle(.secondary)

            FlowLayout(spacing: 8) {
                ForEach(suggestions, id: \.self) { suggestion in
                    Button(suggestion) {
                        if viewModel.variationName.isEmpty {
                            viewModel.variationName = suggestion
                        } else {
                            viewModel.variationName += " \(suggestion)"
                        }
                    }
                    .buttonStyle(.bordered)
                    .controlSize(.small)
                }
            }
        }
        .padding()
    }
}

// Simple horizontal flow layout
struct FlowLayout: Layout {
    var spacing: CGFloat = 8

    func sizeThatFits(proposal: ProposedViewSize, subviews: Subviews, cache: inout ()) -> CGSize {
        let sizes = subviews.map { $0.sizeThatFits(.unspecified) }
        return layout(sizes: sizes, containerWidth: proposal.width ?? .infinity).size
    }

    func placeSubviews(in bounds: CGRect, proposal: ProposedViewSize, subviews: Subviews, cache: inout ()) {
        let sizes = subviews.map { $0.sizeThatFits(.unspecified) }
        let offsets = layout(sizes: sizes, containerWidth: bounds.width).offsets

        for (subview, offset) in zip(subviews, offsets) {
            subview.place(at: CGPoint(x: bounds.minX + offset.x, y: bounds.minY + offset.y), proposal: .unspecified)
        }
    }

    private func layout(sizes: [CGSize], containerWidth: CGFloat) -> (offsets: [CGPoint], size: CGSize) {
        var offsets: [CGPoint] = []
        var currentX: CGFloat = 0
        var currentY: CGFloat = 0
        var lineHeight: CGFloat = 0
        var maxWidth: CGFloat = 0

        for size in sizes {
            if currentX + size.width > containerWidth && currentX > 0 {
                currentX = 0
                currentY += lineHeight + spacing
                lineHeight = 0
            }
            offsets.append(CGPoint(x: currentX, y: currentY))
            currentX += size.width + spacing
            lineHeight = max(lineHeight, size.height)
            maxWidth = max(maxWidth, currentX)
        }

        return (offsets, CGSize(width: maxWidth, height: currentY + lineHeight))
    }
}
```

**EquipmentStepView.swift:**
```swift
import SwiftUI
import SwiftData

struct EquipmentStepView: View {
    @Bindable var viewModel: ExerciseCreationViewModel
    @Query(sort: \Equipment.name) private var equipment: [Equipment]

    var body: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("Select equipment")
                .font(.headline)

            List(equipment, selection: $viewModel.selectedEquipment) { item in
                HStack {
                    Text(item.name)
                    Spacer()
                    if viewModel.selectedEquipment?.id == item.id {
                        Image(systemName: "checkmark")
                            .foregroundStyle(.accent)
                    }
                }
                .contentShape(Rectangle())
                .onTapGesture {
                    viewModel.selectedEquipment = item
                }
            }
            .listStyle(.plain)
        }
        .padding()
    }
}
```

**ExerciseTypeStepView.swift:**
```swift
import SwiftUI

struct ExerciseTypeStepView: View {
    @Bindable var viewModel: ExerciseCreationViewModel

    var body: some View {
        VStack(alignment: .leading, spacing: 16) {
            Text("What do you log?")
                .font(.headline)

            Text("This determines which fields appear when logging sets")
                .font(.subheadline)
                .foregroundStyle(.secondary)

            List(ExerciseType.allCases, id: \.self) { type in
                HStack {
                    VStack(alignment: .leading) {
                        Text(type.displayName)
                            .font(.body)
                        Text(type.logFields.map { $0.rawValue.capitalized }.joined(separator: " + "))
                            .font(.caption)
                            .foregroundStyle(.secondary)
                    }
                    Spacer()
                    if viewModel.selectedExerciseType == type {
                        Image(systemName: "checkmark")
                            .foregroundStyle(.accent)
                    }
                }
                .contentShape(Rectangle())
                .onTapGesture {
                    viewModel.selectedExerciseType = type
                }
            }
            .listStyle(.plain)
        }
        .padding()
    }
}
```
  </action>
  <verify>Build succeeds</verify>
  <done>All four wizard step views created with appropriate selection/input UI</done>
</task>

<task type="auto">
  <name>Task 3: Create ExerciseCreationWizard and wire navigation</name>
  <files>GymAnals/Features/ExerciseLibrary/Views/ExerciseCreationWizard.swift, GymAnals/Features/ExerciseLibrary/Views/ExerciseLibraryView.swift</files>
  <action>
**ExerciseCreationWizard.swift:**
```swift
import SwiftUI
import SwiftData

struct ExerciseCreationWizard: View {
    @Environment(\.modelContext) private var modelContext
    @Environment(\.dismiss) private var dismiss

    @State private var viewModel = ExerciseCreationViewModel()
    @State private var showMuscleEditor = false

    var body: some View {
        NavigationStack {
            VStack(spacing: 0) {
                // Progress dots
                HStack(spacing: 8) {
                    ForEach(0..<viewModel.steps.count, id: \.self) { index in
                        Circle()
                            .fill(index <= viewModel.currentStep ? Color.accentColor : Color.secondary.opacity(0.3))
                            .frame(width: 8, height: 8)
                    }
                }
                .padding(.vertical, 12)

                // Step label
                Text(viewModel.steps[viewModel.currentStep])
                    .font(.caption)
                    .foregroundStyle(.secondary)
                    .padding(.bottom, 8)

                Divider()

                // Step content
                Group {
                    switch viewModel.currentStep {
                    case 0:
                        MovementStepView(viewModel: viewModel)
                    case 1:
                        VariationStepView(viewModel: viewModel)
                    case 2:
                        EquipmentStepView(viewModel: viewModel)
                    case 3:
                        ExerciseTypeStepView(viewModel: viewModel)
                    case 4:
                        // Final step: create and show muscle editor
                        if let variant = viewModel.createdVariant {
                            MuscleWeightEditorView(viewModel: MuscleWeightViewModel(variant: variant))
                        } else {
                            ProgressView()
                                .onAppear {
                                    _ = viewModel.createExercise(context: modelContext)
                                }
                        }
                    default:
                        EmptyView()
                    }
                }
                .frame(maxHeight: .infinity)

                Divider()

                // Navigation buttons
                HStack {
                    if viewModel.currentStep > 0 {
                        Button("Back") {
                            viewModel.previousStep()
                        }
                        .buttonStyle(.bordered)
                    }

                    Spacer()

                    if viewModel.currentStep < viewModel.steps.count - 1 {
                        Button("Next") {
                            viewModel.nextStep()
                        }
                        .buttonStyle(.borderedProminent)
                        .disabled(!viewModel.canProceed)
                    } else {
                        Button("Done") {
                            dismiss()
                        }
                        .buttonStyle(.borderedProminent)
                    }
                }
                .padding()
            }
            .navigationTitle("New Exercise")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("Cancel") {
                        dismiss()
                    }
                }
            }
        }
    }
}

#Preview {
    ExerciseCreationWizard()
        .modelContainer(PersistenceController.preview)
}
```

**ExerciseLibraryView.swift update:**
Update the toolbar "+" button to present the wizard as a sheet:

Add state:
```swift
@State private var showingCreationWizard = false
```

Update toolbar:
```swift
.toolbar {
    ToolbarItem(placement: .primaryAction) {
        Button {
            showingCreationWizard = true
        } label: {
            Image(systemName: "plus")
        }
    }
}
.sheet(isPresented: $showingCreationWizard) {
    ExerciseCreationWizard()
}
```
  </action>
  <verify>
1. Build succeeds
2. Run app, go to Exercise Library, tap + button -> wizard opens
3. Complete all steps -> exercise created and visible in library
  </verify>
  <done>Exercise creation wizard complete, accessible from library toolbar, creates exercise with muscle weights</done>
</task>

</tasks>

<verification>
1. `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 17' build` passes
2. Wizard opens from library toolbar + button
3. Progress dots advance as user moves through steps
4. Back/Next navigation works
5. Created exercise appears in library after completion
6. Created exercise has correct movement, variation, equipment, and type
</verification>

<success_criteria>
- User can access creation wizard from library toolbar
- Progress dots show current step
- User can select existing movement or create new
- User can name variation with suggestions
- User can select equipment
- User can set exercise type
- Final step shows muscle weight editor
- Created exercise appears in library
</success_criteria>

<output>
After completion, create `.planning/phases/02-exercise-library/02-05-SUMMARY.md`
</output>
