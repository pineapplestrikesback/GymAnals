---
phase: 06-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - GymAnals/Resources/presets_all.json
  - GymAnals/Features/Workout/Views/WorkoutTabView.swift
  - GymAnals/Features/Workout/Components/GymSelectorHeader.swift
  - GymAnals/Features/Workout/Views/GymSelectorSheet.swift
autonomous: true

must_haves:
  truths:
    - "Degree symbols display correctly in exercise names and notes (no mojibake)"
    - "Gym selector is disabled/locked when a workout is active"
    - "Newly created gym can be immediately selected without reopening the selector"
  artifacts:
    - path: "GymAnals/Resources/presets_all.json"
      provides: "Corrected character encoding"
      contains: "no occurrences of 'A\\u0302\\u00b0'"
    - path: "GymAnals/Features/Workout/Components/GymSelectorHeader.swift"
      provides: "Disabled state support for gym selector"
      contains: "isDisabled"
    - path: "GymAnals/Features/Workout/Views/WorkoutTabView.swift"
      provides: "Passes hasActiveWorkout to gym selector header"
      contains: "isDisabled: hasActiveWorkout"
  key_links:
    - from: "WorkoutTabView.swift"
      to: "GymSelectorHeader.swift"
      via: "isDisabled parameter"
      pattern: "isDisabled.*hasActiveWorkout"
    - from: "GymSelectorSheet.swift"
      to: "GymSelectionViewModel"
      via: "auto-select after gym creation"
      pattern: "selectedGym"
---

<objective>
Fix character encoding in exercise data and gym state management bugs.

Purpose: Resolve mojibake degree symbols in 24 exercise entries, prevent gym switching during active workouts (which would cause data inconsistency), and ensure newly created gyms are immediately selectable.
Output: Clean exercise data, safe gym-switching behavior, seamless gym creation flow.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-bug-fixes/06-RESEARCH.md

@GymAnals/Resources/presets_all.json
@GymAnals/Features/Workout/Views/WorkoutTabView.swift
@GymAnals/Features/Workout/Components/GymSelectorHeader.swift
@GymAnals/Features/Workout/Views/GymSelectorSheet.swift
@GymAnals/Features/Workout/ViewModels/GymSelectionViewModel.swift
@GymAnals/Features/Workout/Views/GymEditView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix degree symbol encoding and gym selector disabled state</name>
  <files>
    GymAnals/Resources/presets_all.json
    GymAnals/Features/Workout/Components/GymSelectorHeader.swift
    GymAnals/Features/Workout/Views/WorkoutTabView.swift
  </files>
  <action>
    1. **Fix encoding in presets_all.json:**
       - Replace all occurrences of `Â°` (mojibake) with `°` (proper degree symbol). There are exactly 24 occurrences.
       - Use sed: `sed -i '' 's/Â°/°/g' GymAnals/Resources/presets_all.json`
       - Validate JSON after replacement: `python3 -m json.tool GymAnals/Resources/presets_all.json > /dev/null`

    2. **Add disabled state to GymSelectorHeader:**
       - Add `var isDisabled: Bool = false` parameter with default value (backward compatible)
       - Apply `.disabled(isDisabled)` modifier to the Button
       - When disabled, reduce opacity to 0.5 and hide the chevron.down icon (or show a lock icon instead)
       - Show a subtle "locked" visual state (e.g., swap chevron for `lock.fill` icon when disabled)

    3. **Pass hasActiveWorkout to GymSelectorHeader in WorkoutTabView:**
       - Change the GymSelectorHeader initialization to include `isDisabled: hasActiveWorkout`
       - This prevents gym switching during an active workout session
  </action>
  <verify>
    - `python3 -m json.tool GymAnals/Resources/presets_all.json > /dev/null` succeeds
    - `grep -c 'Â°' GymAnals/Resources/presets_all.json` returns 0
    - `grep -c '°' GymAnals/Resources/presets_all.json` returns 24
    - Build succeeds: `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 17 Pro' build`
  </verify>
  <done>
    Degree symbols display correctly (24 occurrences fixed). Gym selector header accepts isDisabled parameter and is disabled during active workouts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable immediate gym selection after creation</name>
  <files>
    GymAnals/Features/Workout/Views/GymSelectorSheet.swift
  </files>
  <action>
    1. **Add auto-select callback to GymSelectorSheet:**
       - Currently the flow is: User opens GymSelectorSheet -> taps "Manage Gyms" -> GymManagementView opens -> user creates gym in GymEditView -> GymEditView dismisses -> GymManagementView is still open -> user must manually find and select the new gym.
       - The fix: When the GymManagementView sheet (opened from the selector) is dismissed, the selector's @Query will have refreshed. But the user still needs to tap the new gym.
       - Better approach: Add an `onGymCreated` callback mechanism. In GymSelectorSheet, when the management sheet dismisses, check if a new gym was created and auto-select it.
       - Simpler approach: Since `GymSelectorSheet` already has `@Binding var selectedGym: Gym?`, add a new `@State private var showingNewGymSheet = false` and a "New Gym" button directly in the selector sheet (alongside "Manage Gyms"). When creating from the selector directly:
         a. Add a "New Gym" row/button at the top of the gym list in GymSelectorSheet
         b. Present GymEditView as a sheet directly from GymSelectorSheet
         c. After GymEditView saves, auto-select the new gym by finding the most recently created gym and setting `selectedGym` to it, then dismiss
       - Keep the existing "Manage Gyms" button for the full management flow.
       - Implementation details:
         a. Add `@State private var showingNewGymSheet = false` to GymSelectorSheet
         b. Add a section before the gym list with a "New Gym" button
         c. Present `.sheet(isPresented: $showingNewGymSheet)` with a NavigationStack containing GymEditView
         d. In the `.onChange(of: showingNewGymSheet)` (when it changes to false), find the most recently created gym (sorted by creation date or just the newest ID) and set it as `selectedGym`, then dismiss the selector

    2. **Ensure context is saved before selection:**
       - In the onDismiss of the new gym sheet, add a small delay or use `onChange` to ensure the `@Query` has refreshed before trying to select.
  </action>
  <verify>
    Build succeeds: `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 17 Pro' build`
  </verify>
  <done>
    GymSelectorSheet has a "New Gym" button that opens GymEditView directly. After saving a new gym, it is auto-selected and the selector dismisses. The existing "Manage Gyms" flow remains unchanged.
  </done>
</task>

</tasks>

<verification>
- `python3 -m json.tool GymAnals/Resources/presets_all.json > /dev/null` passes (valid JSON)
- Zero `Â°` occurrences in presets_all.json
- Build compiles without errors
- GymSelectorHeader accepts isDisabled parameter
- WorkoutTabView passes hasActiveWorkout to GymSelectorHeader
- GymSelectorSheet has "New Gym" button with auto-select
</verification>

<success_criteria>
1. SC3: All 24 mojibake degree symbols replaced with proper `°` in presets_all.json
2. SC1: Gym selector is visually disabled and non-interactive during active workouts
3. SC2: Creating a new gym from the selector auto-selects it and dismisses the sheet
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes/06-01-SUMMARY.md`
</output>
