---
phase: 06-bug-fixes
plan: 04
type: execute
wave: 2
depends_on: [03]
files_modified:
  - GymAnals/Features/Workout/Views/ExercisePickerSheet.swift
  - GymAnals/Features/Workout/Components/WorkoutHeader.swift
  - GymAnals/Features/Workout/Views/ActiveWorkoutView.swift
autonomous: true

must_haves:
  truths:
    - "Exercise picker supports multi-select with checkboxes and an 'Add (N)' confirmation button"
    - "Exercise picker includes muscle group filter tabs matching library view"
    - "Rest timer section is always visible in workout header (placeholder when no timer active)"
    - "Gym name and color dot display in the workout header"
    - "User can tap timer area in header to start a manual rest timer"
  artifacts:
    - path: "GymAnals/Features/Workout/Views/ExercisePickerSheet.swift"
      provides: "Multi-select picker with muscle group filter tabs"
      contains: "selectedExerciseIDs"
    - path: "GymAnals/Features/Workout/Components/WorkoutHeader.swift"
      provides: "Always-visible timer section and gym indicator"
      contains: "gym"
    - path: "GymAnals/Features/Workout/Views/ActiveWorkoutView.swift"
      provides: "Updated picker callback and gym/timer wiring"
      contains: "onSelectExercises"
  key_links:
    - from: "ExercisePickerSheet.swift"
      to: "ActiveWorkoutView.swift"
      via: "multi-exercise callback"
      pattern: "\\[Exercise\\].*Void"
    - from: "ActiveWorkoutView.swift"
      to: "WorkoutHeader.swift"
      via: "gym parameter"
      pattern: "gym.*viewModel"
    - from: "WorkoutHeader.swift"
      to: "timer display"
      via: "always-visible timer section"
      pattern: "Rest|timer"
---

<objective>
Add multi-select exercise picker with search parity, always-visible rest timer, and gym indicator in workout header.

Purpose: These four improvements (SC4, SC7, SC9, SC10) transform the workout logging experience. Multi-select eliminates repeated sheet open/close cycles when adding exercises. Always-visible timer prevents layout shifts and provides a persistent tap target. Gym indicator gives context about which gym's weight history applies. Search parity ensures consistent exercise discovery.
Output: Multi-select picker with muscle group tabs, persistent header timer, gym-themed header.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-bug-fixes/06-RESEARCH.md

@GymAnals/Features/Workout/Views/ExercisePickerSheet.swift
@GymAnals/Features/Workout/Components/WorkoutHeader.swift
@GymAnals/Features/Workout/Views/ActiveWorkoutView.swift
@GymAnals/Features/ExerciseLibrary/Components/MuscleGroupFilterTabs.swift
@GymAnals/Features/ExerciseLibrary/Views/ExerciseRow.swift
@GymAnals/Models/Enums/MuscleGroup.swift
@GymAnals/Models/Core/Gym.swift
@GymAnals/Features/Workout/Models/SetTimer.swift
@GymAnals/Features/Workout/ViewModels/ActiveWorkoutViewModel.swift
@GymAnals/Features/Workout/ViewModels/SetTimerManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Multi-select exercise picker with muscle group filter tabs</name>
  <files>
    GymAnals/Features/Workout/Views/ExercisePickerSheet.swift
    GymAnals/Features/Workout/Views/ActiveWorkoutView.swift
  </files>
  <action>
    1. **Rewrite ExercisePickerSheet for multi-select (SC7):**
       - Change callback from `let onSelectExercise: (Exercise) -> Void` to `let onSelectExercises: ([Exercise]) -> Void`
       - Add `@State private var selectedExerciseIDs: Set<String> = []`
       - Change the List row from a Button that calls onSelectExercise+dismiss to a Button that toggles selection:
         ```swift
         Button {
             toggleSelection(exercise)
         } label: {
             HStack {
                 ExerciseRow(exercise: exercise)
                 Spacer()
                 Image(systemName: selectedExerciseIDs.contains(exercise.id)
                     ? "checkmark.circle.fill" : "circle")
                     .foregroundStyle(selectedExerciseIDs.contains(exercise.id) ? .accentColor : .secondary)
                     .font(.title3)
             }
         }
         .tint(.primary)
         ```
       - Add toggle helper:
         ```swift
         private func toggleSelection(_ exercise: Exercise) {
             if selectedExerciseIDs.contains(exercise.id) {
                 selectedExerciseIDs.remove(exercise.id)
             } else {
                 selectedExerciseIDs.insert(exercise.id)
             }
         }
         ```
       - Add confirmation toolbar button:
         ```swift
         ToolbarItem(placement: .confirmationAction) {
             Button("Add (\(selectedExerciseIDs.count))") {
                 let selected = exercises.filter { selectedExerciseIDs.contains($0.id) }
                 onSelectExercises(selected)
                 dismiss()
             }
             .disabled(selectedExerciseIDs.isEmpty)
         }
         ```
       - Keep the Cancel button in .cancellationAction placement

    2. **Add muscle group filter tabs (SC4):**
       - Add `@State private var selectedMuscleGroup: MuscleGroup? = nil`
       - Add MuscleGroupFilterTabs above the List (or below .searchable):
         ```swift
         VStack(spacing: 0) {
             MuscleGroupFilterTabs(selectedGroup: $selectedMuscleGroup)
             List(filteredExercises) { ... }
         }
         ```
       - Update `filteredExercises` to also filter by muscle group:
         ```swift
         private var filteredExercises: [Exercise] {
             var result = exercises

             // Apply muscle group filter
             if let group = selectedMuscleGroup {
                 result = result.filter { $0.primaryMuscleGroup == group }
             }

             // Apply search filter
             if !searchText.isEmpty {
                 let lowered = searchText.lowercased()
                 result = result.filter { exercise in
                     exercise.displayName.localizedCaseInsensitiveContains(searchText) ||
                     exercise.searchTerms.contains { $0.lowercased().contains(lowered) } ||
                     exercise.movement?.displayName.localizedCaseInsensitiveContains(searchText) == true
                 }
             } else if selectedMuscleGroup == nil {
                 // Only limit to 50 when no filters active
                 result = Array(result.prefix(50))
             }

             return result
         }
         ```
       - Note: MuscleGroupFilterTabs already exists as a reusable component from Phase 2.

    3. **Update ActiveWorkoutView's picker sheet callback:**
       - Change from:
         ```swift
         .sheet(isPresented: $showingExercisePicker) {
             ExercisePickerSheet { exercise in
                 viewModel.addExercise(exercise)
                 viewModel.addSet(for: exercise)
             }
         }
         ```
       - To:
         ```swift
         .sheet(isPresented: $showingExercisePicker) {
             ExercisePickerSheet { exercises in
                 for exercise in exercises {
                     viewModel.addExercise(exercise)
                     viewModel.addSet(for: exercise)
                 }
             }
         }
         ```
       - Use `withAnimation` around the batch add for smooth UI update
  </action>
  <verify>
    Build succeeds: `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 17 Pro' build`
  </verify>
  <done>
    Exercise picker shows checkboxes for multi-select with "Add (N)" button. Muscle group filter tabs are available for exercise filtering. ActiveWorkoutView handles batch exercise addition.
  </done>
</task>

<task type="auto">
  <name>Task 2: Always-visible rest timer and gym indicator in workout header</name>
  <files>
    GymAnals/Features/Workout/Components/WorkoutHeader.swift
    GymAnals/Features/Workout/Views/ActiveWorkoutView.swift
  </files>
  <action>
    1. **Add gym parameter to WorkoutHeader (SC10):**
       - Add `let gym: Gym?` parameter to WorkoutHeader
       - Add a gym indicator row above the existing HStack:
         ```swift
         VStack(spacing: 4) {
             // Gym indicator
             if let gym {
                 HStack(spacing: 6) {
                     Circle()
                         .fill(gym.colorTag.color)
                         .frame(width: 8, height: 8)
                     Text(gym.name)
                         .font(.caption)
                         .foregroundStyle(.secondary)
                 }
             }

             // Existing header content
             HStack { ... }
         }
         ```

    2. **Make rest timer always visible (SC9):**
       - Remove the conditional `if let timer = headerTimer, !timer.isExpired { ... }`
       - Always show the timer section in the HStack:
         ```swift
         // Timer section (always visible)
         Button(action: onTimerTap) {
             VStack(alignment: .trailing, spacing: 2) {
                 Text("Rest")
                     .font(.caption)
                     .foregroundStyle(.secondary)
                 if let timer = headerTimer, !timer.isExpired {
                     Text(formattedTimerRemaining(timer))
                         .font(.title3)
                         .monospacedDigit()
                         .foregroundStyle(.orange)
                 } else {
                     Text("--:--")
                         .font(.title3)
                         .monospacedDigit()
                         .foregroundStyle(.tertiary)
                 }
             }
         }
         .buttonStyle(.plain)
         ```
       - This ensures the timer section is always tappable and prevents layout shifts when timer starts/stops

    3. **Update WorkoutHeader preview** to include gym parameter:
       - Pass `gym: nil` to existing previews
       - Add a preview with gym (would need model container for real gym object -- can use nil for simplicity)

    4. **Pass gym to WorkoutHeader in ActiveWorkoutView:**
       - Update the WorkoutHeader instantiation in ActiveWorkoutView to pass the gym:
         ```swift
         WorkoutHeader(
             startDate: viewModel.activeWorkout?.startDate ?? .now,
             totalSets: viewModel.activeWorkout?.sets.count ?? 0,
             headerTimer: timerManager.headerTimer,
             gym: viewModel.activeWorkout?.gym,
             onTimerTap: { ... }
         )
         ```
       - Check if `Workout` model has a `gym` property. If not, the gym can be obtained from `viewModel.activeWorkout?.gym` -- verify the Workout model. If Workout doesn't have a gym property, we need to get it another way (e.g., from the GymSelectionViewModel or store it when workout starts).
       - Look at `ActiveWorkoutViewModel.startWorkout(at:)` -- it receives a gym. Check if the Workout model stores it. If yes, use `viewModel.activeWorkout?.gym`. If not, add a `gym` property to the ViewModel that stores the gym passed at workout start.

    5. **Make timer tappable when no timer is active:**
       - The `onTimerTap` closure in ActiveWorkoutView currently only fires when `timerManager.headerTimer` exists:
         ```swift
         onTimerTap: {
             if let timer = timerManager.headerTimer {
                 selectedTimerForControls = timer
                 showingTimerControls = true
             }
         }
         ```
       - Update to handle the no-timer case: when tapped with no active timer, start a default rest timer (e.g., 120s) and show controls:
         ```swift
         onTimerTap: {
             if let timer = timerManager.headerTimer, !timer.isExpired {
                 selectedTimerForControls = timer
                 showingTimerControls = true
             } else {
                 // Start a manual rest timer with default duration
                 let manualTimer = timerManager.startManualTimer(duration: 120)
                 selectedTimerForControls = manualTimer
                 showingTimerControls = true
             }
         }
         ```
       - Check if `SetTimerManager` has a `startManualTimer` method. If not, add one that creates a timer not tied to a specific set ID (use a sentinel UUID or nil-safe approach). The simplest approach: use `timerManager.startTimer(for: UUID(), duration: 120)` with a random UUID since it's a manual timer.
  </action>
  <verify>
    Build succeeds: `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 17 Pro' build`
  </verify>
  <done>
    WorkoutHeader always shows timer section (with "--:--" placeholder when inactive). Gym name and color dot appear in header. Timer section is tappable at all times. Tapping when no timer active starts a default 120s rest timer.
  </done>
</task>

</tasks>

<verification>
- Build compiles without errors
- ExercisePickerSheet shows checkboxes and "Add (N)" button
- MuscleGroupFilterTabs appear in the picker
- WorkoutHeader shows gym indicator with color dot
- Timer section always visible (no layout shift)
- Timer tappable even when no timer is active
</verification>

<success_criteria>
1. SC4: Exercise picker has muscle group filter tabs matching the library view
2. SC7: Exercise picker supports multi-select with checkboxes and batch "Add (N)" confirmation
3. SC9: Rest timer section always visible in header, tappable to start manual timer
4. SC10: Gym name with color dot visible in workout header
</success_criteria>

<output>
After completion, create `.planning/phases/06-bug-fixes/06-04-SUMMARY.md`
</output>
