---
phase: 04-workout-logging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - GymAnals/Models/Core/Exercise.swift
  - GymAnals/Features/Workout/Models/SetTimer.swift
  - GymAnals/Features/Workout/ViewModels/SetTimerManager.swift
  - GymAnals/Services/Notifications/RestTimerNotificationService.swift
  - GymAnals/App/AppConstants.swift
autonomous: true

must_haves:
  truths:
    - "Timer end time survives app backgrounding"
    - "Local notification schedules when timer starts"
    - "Notification cancels when timer is skipped"
  artifacts:
    - path: "GymAnals/Features/Workout/Models/SetTimer.swift"
      provides: "Timer data structure with Date-based endTime"
      contains: "struct SetTimer"
    - path: "GymAnals/Features/Workout/ViewModels/SetTimerManager.swift"
      provides: "Timer state management"
      contains: "class SetTimerManager"
    - path: "GymAnals/Services/Notifications/RestTimerNotificationService.swift"
      provides: "Local notification scheduling"
      contains: "scheduleRestTimerNotification"
  key_links:
    - from: "SetTimerManager"
      to: "RestTimerNotificationService"
      via: "scheduleNotification on timer start"
      pattern: "RestTimerNotificationService.*schedule"
---

<objective>
Create the timer infrastructure for per-set rest timers with background persistence and local notifications.

Purpose: This foundation enables the novel per-set independent timer system that differentiates this app. Timers must survive app backgrounding by storing end times as Date values rather than countdown seconds.

Output: SetTimer struct, SetTimerManager observable class, RestTimerNotificationService, and model updates for rest duration.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-workout-logging/04-CONTEXT.md
@.planning/phases/04-workout-logging/04-RESEARCH.md
@GymAnals/Models/Core/Exercise.swift
@GymAnals/App/AppConstants.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SetTimer struct and SetTimerManager</name>
  <files>
    GymAnals/Features/Workout/Models/SetTimer.swift
    GymAnals/Features/Workout/ViewModels/SetTimerManager.swift
  </files>
  <action>
Create SetTimer.swift as a lightweight struct (not SwiftData model):
```swift
struct SetTimer: Identifiable {
    let id: UUID
    let setID: UUID  // Associated WorkoutSet
    let endTime: Date  // Store end time, not countdown seconds

    var remainingSeconds: Int {
        max(0, Int(endTime.timeIntervalSinceNow))
    }

    var isExpired: Bool {
        remainingSeconds == 0
    }

    init(id: UUID = UUID(), setID: UUID, duration: TimeInterval) {
        self.id = id
        self.setID = setID
        self.endTime = Date.now.addingTimeInterval(duration)
    }
}
```

Create SetTimerManager.swift as @Observable @MainActor class:
- `activeTimers: [SetTimer]` - all running timers
- `var headerTimer: SetTimer?` - computed, returns most recently started timer (highest endTime)
- `startTimer(for setID: UUID, duration: TimeInterval)` - creates and appends timer, schedules notification for header timer only
- `removeExpiredTimers()` - filters out expired timers
- `skipTimer(_ timer: SetTimer)` - removes specific timer, cancels notification if it was header timer
- `extendTimer(_ timer: SetTimer, by seconds: TimeInterval)` - creates new timer with extended end time
- Inject RestTimerNotificationService dependency

The manager should only schedule notifications for the header timer (most recent), not all timers.
  </action>
  <verify>Files compile without errors: `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -20`</verify>
  <done>SetTimer struct stores Date-based endTime with computed remainingSeconds. SetTimerManager manages multiple independent timers with header timer concept.</done>
</task>

<task type="auto">
  <name>Task 2: Create RestTimerNotificationService</name>
  <files>
    GymAnals/Services/Notifications/RestTimerNotificationService.swift
  </files>
  <action>
Create RestTimerNotificationService.swift:
- Singleton pattern: `static let shared = RestTimerNotificationService()`
- `@MainActor` for thread safety
- `func requestPermission() async -> Bool` - requests notification authorization
- `func scheduleRestTimerNotification(id: String, after seconds: TimeInterval)` - schedules time-interval triggered notification with title "Rest Complete", body "Time to start your next set!"
- `func cancelNotification(id: String)` - removes pending notification by identifier
- `func cancelAllRestTimerNotifications()` - removes all pending notifications

Use UNUserNotificationCenter with:
- UNMutableNotificationContent for content
- UNTimeIntervalNotificationTrigger with repeats: false
- UNNotificationRequest with the provided id

Import UserNotifications framework.
  </action>
  <verify>Files compile. Test notification service initialization in preview.</verify>
  <done>RestTimerNotificationService can schedule and cancel local notifications for rest timer completion.</done>
</task>

<task type="auto">
  <name>Task 3: Add default rest duration constant and update Exercise model</name>
  <files>
    GymAnals/App/AppConstants.swift
    GymAnals/Models/Core/Exercise.swift
  </files>
  <action>
Update AppConstants.swift - add:
```swift
static let defaultRestDuration: TimeInterval = 120  // 2 minutes
static let weightIncrementKg: Double = 1.0
static let weightIncrementLbs: Double = 2.5  // Research recommended 2.5 over 1.25
```

Update Exercise.swift - add property:
```swift
var restDuration: TimeInterval = 120  // Default 2 minutes, adjustable per exercise
var autoStartTimer: Bool = true  // Whether to auto-start timer on set completion
```

These properties allow per-exercise rest timer customization as specified in CONTEXT.md.
  </action>
  <verify>Build succeeds. Exercise model has restDuration property accessible.</verify>
  <done>Default rest duration constant exists. Exercise model supports per-exercise rest duration and auto-start toggle.</done>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build`
2. SetTimer.remainingSeconds returns correct value based on endTime vs Date.now
3. SetTimerManager.headerTimer returns the timer with highest endTime
4. RestTimerNotificationService.shared is accessible
5. Exercise.restDuration defaults to 120 seconds
</verification>

<success_criteria>
- Timer infrastructure exists with Date-based persistence pattern
- Notification service can schedule/cancel notifications
- No explicit timer countdown state - all derived from endTime Date
- Model supports per-exercise rest customization
</success_criteria>

<output>
After completion, create `.planning/phases/04-workout-logging/04-01-SUMMARY.md`
</output>
