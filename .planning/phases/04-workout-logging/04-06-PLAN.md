---
phase: 04-workout-logging
plan: 06
type: execute
wave: 4
depends_on: ["04-05"]
files_modified:
  - GymAnals/Features/Workout/Views/WorkoutTabView.swift
  - GymAnals/App/GymAnalsApp.swift
autonomous: false

must_haves:
  truths:
    - "Start Workout button creates workout and navigates to ActiveWorkoutView"
    - "Resume Workout appears if active workout exists"
    - "Crash recovery: reopening app resumes active workout"
    - "Notification permission requested on first timer start"
  artifacts:
    - path: "GymAnals/Features/Workout/Views/WorkoutTabView.swift"
      provides: "Updated workout tab with start/resume flow"
      contains: "NavigationLink"
  key_links:
    - from: "WorkoutTabView"
      to: "ActiveWorkoutView"
      via: "navigationDestination"
      pattern: "navigationDestination.*ActiveWorkoutView"
---

<objective>
Integrate ActiveWorkoutView into the app flow and add crash recovery resume functionality.

Purpose: Users need to start workouts from the Workout tab and seamlessly resume if the app was terminated during a workout. This completes the workout logging feature.

Output: Updated WorkoutTabView with start/resume flow, notification permission request, and checkpoint for human verification.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-workout-logging/04-CONTEXT.md
@.planning/phases/04-workout-logging/04-RESEARCH.md
@.planning/phases/04-workout-logging/04-05-SUMMARY.md
@GymAnals/Features/Workout/Views/WorkoutTabView.swift
@GymAnals/App/GymAnalsApp.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update WorkoutTabView with start/resume workout flow</name>
  <files>
    GymAnals/Features/Workout/Views/WorkoutTabView.swift
  </files>
  <action>
Update WorkoutTabView.swift:

Add state:
```swift
@State private var activeWorkoutViewModel: ActiveWorkoutViewModel?
@State private var timerManager = SetTimerManager()
@State private var showingActiveWorkout = false
@State private var hasActiveWorkout = false
```

On appear, check for active workout:
```swift
.onAppear {
    if viewModel == nil {
        viewModel = GymSelectionViewModel(modelContext: modelContext)
    }
    checkForActiveWorkout()
}

private func checkForActiveWorkout() {
    let descriptor = FetchDescriptor<Workout>(
        predicate: #Predicate { $0.isActive == true }
    )
    hasActiveWorkout = (try? modelContext.fetchCount(descriptor)) ?? 0 > 0
}
```

Update "Start Workout" button:
- If hasActiveWorkout: show "Resume Workout" with play.fill icon, green style
- If not: show "Start Workout" with plus.circle.fill icon, accent style
- On tap:
  - If resuming: create ActiveWorkoutViewModel (it auto-loads active workout)
  - If starting: create ViewModel, call startWorkout(at: viewModel?.selectedGym)
  - Set showingActiveWorkout = true

Add navigation destination:
```swift
.navigationDestination(isPresented: $showingActiveWorkout) {
    if let vm = activeWorkoutViewModel {
        ActiveWorkoutView(viewModel: vm, timerManager: timerManager)
    }
}
```

When returning from ActiveWorkoutView:
- Clear activeWorkoutViewModel
- Re-check hasActiveWorkout
- Refresh timer manager if needed

Add .onChange(of: showingActiveWorkout) to handle dismissal cleanup.
  </action>
  <verify>Build succeeds. Start/Resume button appears correctly based on active workout state.</verify>
  <done>WorkoutTabView shows Start or Resume Workout button and navigates to ActiveWorkoutView with proper ViewModel injection.</done>
</task>

<task type="auto">
  <name>Task 2: Add notification permission request</name>
  <files>
    GymAnals/Features/Workout/ViewModels/SetTimerManager.swift
    GymAnals/App/GymAnalsApp.swift
  </files>
  <action>
Update SetTimerManager to request notification permission on first timer:
```swift
@Observable
@MainActor
final class SetTimerManager {
    // ... existing code ...

    private var hasRequestedNotificationPermission = false

    func startTimer(for setID: UUID, duration: TimeInterval) {
        let timer = SetTimer(setID: setID, duration: duration)
        activeTimers.append(timer)

        // Request permission if this is header timer
        if !hasRequestedNotificationPermission {
            Task {
                let granted = await RestTimerNotificationService.shared.requestPermission()
                hasRequestedNotificationPermission = true
                if granted {
                    scheduleHeaderNotification()
                }
            }
        } else {
            scheduleHeaderNotification()
        }
    }

    private func scheduleHeaderNotification() {
        guard let header = headerTimer else { return }
        let remaining = TimeInterval(header.remainingSeconds)
        if remaining > 0 {
            RestTimerNotificationService.shared.scheduleRestTimerNotification(
                id: header.id.uuidString,
                after: remaining
            )
        }
    }
}
```

This ensures:
- First timer start triggers permission prompt
- Only header timer gets notification
- Permission only requested once per session
  </action>
  <verify>Build succeeds. Timer start triggers notification scheduling.</verify>
  <done>Notification permission requested on first timer start, notification scheduled for header timer only.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete workout logging feature:
- Start/Resume workout from Workout tab
- Add exercises from library (FAB)
- Log sets with reps and weight (stepper + keyboard)
- See previous workout values inline
- Per-set rest timers with notification
- Edit and delete sets (swipe)
- Collapsible exercise sections
- Sticky header with duration and timer
- Finish or discard workout
- Crash recovery (active workout persists)
  </what-built>
  <how-to-verify>
1. Launch app in simulator: `open -a Simulator && xcrun simctl boot "iPhone 16"`
2. Build and run: `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build`

**Test Start Workout:**
- Go to Workout tab
- Tap "Start Workout"
- Verify ActiveWorkoutView appears with empty state
- Verify sticky header shows "0:00" duration and "0" sets

**Test Add Exercise:**
- Tap floating "+" button
- Search for an exercise (e.g., "Bench")
- Select it
- Verify exercise section appears expanded

**Test Log Sets:**
- Tap "+Add Set" within an exercise
- Adjust reps with +/- buttons
- Tap weight field, type a value
- Tap checkmark to confirm
- Verify set is logged and timer badge appears
- Wait for timer to count down (or test timer controls)

**Test Previous Values (requires 2nd workout):**
- Finish first workout
- Start new workout at same gym
- Add same exercise
- Verify "last: X" hints appear under reps/weight fields

**Test Swipe Delete:**
- Swipe left on a set row
- Verify delete option appears
- Delete a set

**Test Crash Recovery:**
- Start a workout and log a few sets
- Force quit app (swipe up in app switcher)
- Relaunch app
- Verify "Resume Workout" button appears
- Tap to resume and verify workout state is preserved

**Test Finish Workout:**
- Tap "Finish Workout" at bottom
- Confirm in dialog
- Verify returns to Workout tab
- Verify no "Resume Workout" appears (workout completed)
  </how-to-verify>
  <resume-signal>Type "approved" to confirm workout logging works correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build`
2. Start Workout creates new workout and navigates
3. Resume Workout loads existing active workout
4. Complete workout flow works end-to-end
5. Crash recovery preserves workout state
</verification>

<success_criteria>
- LOG-01: User can start a workout (optionally at gym) ✓
- LOG-02: User can add exercises from library ✓
- LOG-03: User can log sets in under 10 seconds ✓
- LOG-04: Previous workout numbers shown inline ✓
- LOG-05: User can edit/delete sets ✓
- LOG-06: Rest timer with notification ✓
- LOG-07: User can finish and save workout ✓
- LOG-08: Auto-save (crash recovery) works ✓
</success_criteria>

<output>
After completion, create `.planning/phases/04-workout-logging/04-06-SUMMARY.md`
</output>
