---
phase: 04-workout-logging
plan: 05
type: execute
wave: 3
depends_on: ["04-03", "04-04"]
files_modified:
  - GymAnals/Features/Workout/Components/WorkoutHeader.swift
  - GymAnals/Features/Workout/Components/TimerControlsPopover.swift
  - GymAnals/Features/Workout/Views/ActiveWorkoutView.swift
autonomous: true

must_haves:
  truths:
    - "Sticky header shows elapsed duration, total sets, and rest timer"
    - "Tapping header timer opens controls popover"
    - "All exercises render in scrollable list with FAB overlay"
    - "Finish button saves workout with endDate"
  artifacts:
    - path: "GymAnals/Features/Workout/Components/WorkoutHeader.swift"
      provides: "Sticky header component"
      contains: "struct WorkoutHeader"
    - path: "GymAnals/Features/Workout/Views/ActiveWorkoutView.swift"
      provides: "Main workout session view"
      min_lines: 150
      contains: "LazyVStack"
  key_links:
    - from: "ActiveWorkoutView"
      to: "ActiveWorkoutViewModel"
      via: "@State var viewModel"
      pattern: "@State.*ActiveWorkoutViewModel"
    - from: "ActiveWorkoutView"
      to: "SetTimerManager"
      via: "@State var timerManager"
      pattern: "@State.*SetTimerManager"
---

<objective>
Create the main ActiveWorkoutView that assembles all workout components into a cohesive workout session experience.

Purpose: This is the primary view users interact with during a workout. It combines the sticky header, exercise sections, FAB, and finish flow into a complete experience.

Output: WorkoutHeader with timer controls, TimerControlsPopover for timer adjustments, and ActiveWorkoutView as the complete workout session screen.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-workout-logging/04-CONTEXT.md
@.planning/phases/04-workout-logging/04-RESEARCH.md
@.planning/phases/04-workout-logging/04-01-SUMMARY.md
@.planning/phases/04-workout-logging/04-02-SUMMARY.md
@.planning/phases/04-workout-logging/04-03-SUMMARY.md
@.planning/phases/04-workout-logging/04-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkoutHeader component</name>
  <files>
    GymAnals/Features/Workout/Components/WorkoutHeader.swift
  </files>
  <action>
Create WorkoutHeader.swift:
```swift
struct WorkoutHeader: View {
    let startDate: Date
    let totalSets: Int
    let headerTimer: SetTimer?
    let onTimerTap: () -> Void

    @State private var elapsedSeconds: Int = 0
    private let updateTimer = Timer.publish(every: 1, on: .main, in: .common).autoconnect()
}
```

Layout (HStack with Spacers):
1. Duration section (VStack, .leading):
   - "Duration" label (.caption, .secondary)
   - Elapsed time formatted as "H:MM:SS" or "M:SS" (.title3, .monospacedDigit)

2. Sets section (VStack, .center):
   - "Sets" label (.caption, .secondary)
   - Total sets count (.title3)

3. Timer section (VStack, conditional on headerTimer):
   - "Rest" label (.caption, .secondary)
   - Timer remaining in .orange foreground (.title3, .monospacedDigit)
   - Wrapped in Button calling onTimerTap

Use .onReceive(updateTimer) to update elapsedSeconds from startDate.
Format duration: hours if >= 3600, otherwise minutes:seconds.

Styling:
- .padding() on full HStack
- .background(.regularMaterial) for sticky header appearance
  </action>
  <verify>Build succeeds. Header shows duration counting up and timer counting down.</verify>
  <done>WorkoutHeader displays elapsed duration, total sets completed, and rest timer with tap action.</done>
</task>

<task type="auto">
  <name>Task 2: Create TimerControlsPopover</name>
  <files>
    GymAnals/Features/Workout/Components/TimerControlsPopover.swift
  </files>
  <action>
Create TimerControlsPopover.swift:
```swift
struct TimerControlsPopover: View {
    let timer: SetTimer
    let onSkip: () -> Void
    let onExtend30s: () -> Void
    let onExtend1m: () -> Void

    @State private var remainingSeconds: Int = 0
    private let updateTimer = Timer.publish(every: 1, on: .main, in: .common).autoconnect()
}
```

Layout (VStack):
1. Current remaining time display (.title, .monospacedDigit, centered)
2. Divider
3. HStack of action buttons:
   - "Skip" button (xmark.circle) - calls onSkip
   - "+30s" button (plus.circle) - calls onExtend30s
   - "+1m" button (plus.circle) - calls onExtend1m

Button styling:
- .buttonStyle(.bordered)
- Skip in .red tint
- Extend buttons in default accent

Sizing:
- Frame width ~200 for popover
- Comfortable padding
  </action>
  <verify>Build succeeds. Popover shows timer and control buttons.</verify>
  <done>TimerControlsPopover provides skip and extend controls for rest timer.</done>
</task>

<task type="auto">
  <name>Task 3: Create ActiveWorkoutView</name>
  <files>
    GymAnals/Features/Workout/Views/ActiveWorkoutView.swift
  </files>
  <action>
Create ActiveWorkoutView.swift:
```swift
struct ActiveWorkoutView: View {
    @Environment(\.modelContext) private var modelContext
    @Environment(\.dismiss) private var dismiss
    @State var viewModel: ActiveWorkoutViewModel
    @State var timerManager: SetTimerManager

    @State private var showingExercisePicker = false
    @State private var showingTimerControls = false
    @State private var showingFinishConfirmation = false
    @State private var showingDiscardConfirmation = false
    @FocusState private var focusedField: SetEntryField?
}
```

Body structure:
```swift
ZStack(alignment: .bottomTrailing) {
    ScrollView {
        LazyVStack(spacing: 0, pinnedViews: [.sectionHeaders]) {
            Section {
                // Exercise sections
                ForEach(viewModel.exerciseOrder, id: \.self) { exerciseID in
                    // Get exercise and sets, render ExerciseSectionView
                }

                // Empty state if no exercises
                if viewModel.exerciseOrder.isEmpty {
                    emptyStateView
                }

                // Finish Workout button at bottom
                if !viewModel.exerciseOrder.isEmpty {
                    finishWorkoutButton
                }
            } header: {
                WorkoutHeader(
                    startDate: viewModel.activeWorkout?.startDate ?? .now,
                    totalSets: viewModel.activeWorkout?.sets.count ?? 0,
                    headerTimer: timerManager.headerTimer,
                    onTimerTap: { showingTimerControls = true }
                )
            }
        }
    }

    AddExerciseFAB {
        showingExercisePicker = true
    }
    .padding()
}
```

For each exerciseID in ForEach:
- Fetch exercise from context by ID
- Get sets via viewModel.setsForExercise
- Create bindings for reps/weight that update the WorkoutSet directly
- Pass previous values from viewModel.previousSetForRow

finishWorkoutButton:
- "Finish Workout" with checkmark.circle icon
- .buttonStyle(.borderedProminent)
- Shows confirmationDialog for confirmation
- Calls viewModel.finishWorkout() and dismiss()

Toolbar:
- .navigationTitle("Workout") with gym name subtitle if available
- .navigationBarTitleDisplayMode(.inline)
- Menu (...) in trailing with "Discard Workout" option (destructive, shows confirmation)

Sheets/Dialogs:
- .sheet for ExercisePickerSheet
- .popover for TimerControlsPopover
- .confirmationDialog for finish/discard

Handle set confirmation:
- Update exercise.lastUsedDate
- Start timer if exercise.autoStartTimer is true
- Remove expired timers
- Use timerManager.startTimer(for:duration:)
  </action>
  <verify>Build succeeds. View compiles with all components wired together.</verify>
  <done>ActiveWorkoutView is the complete workout session screen with sticky header, exercise sections, FAB, and finish/discard flow.</done>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build`
2. WorkoutHeader sticky stays at top during scroll
3. Timer controls popover opens on header timer tap
4. FAB opens exercise picker sheet
5. Finish workout button shows confirmation and dismisses
6. Discard option in menu shows confirmation
</verification>

<success_criteria>
- Sticky header always visible with duration, sets, timer
- Exercise sections scrollable with proper FAB overlay
- Timer controls accessible via header tap
- Finish saves workout (isActive=false, endDate set)
- Discard deletes workout and dismisses
- All components integrate without compile errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-workout-logging/04-05-SUMMARY.md`
</output>
