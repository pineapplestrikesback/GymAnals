---
phase: 04-workout-logging
plan: 04
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - GymAnals/Features/Workout/Views/ExerciseSectionView.swift
  - GymAnals/Features/Workout/Views/ExercisePickerSheet.swift
  - GymAnals/Features/Workout/Components/AddExerciseFAB.swift
autonomous: true

must_haves:
  truths:
    - "Exercise sections are collapsible with all expanded by default"
    - "Swipe left on set row deletes the set"
    - "'+Add Set' button adds new set within exercise"
    - "Exercise picker shows recent exercises with search"
  artifacts:
    - path: "GymAnals/Features/Workout/Views/ExerciseSectionView.swift"
      provides: "Collapsible exercise container with sets"
      contains: "DisclosureGroup"
    - path: "GymAnals/Features/Workout/Views/ExercisePickerSheet.swift"
      provides: "Exercise selection from library"
      contains: "searchable"
    - path: "GymAnals/Features/Workout/Components/AddExerciseFAB.swift"
      provides: "Floating action button"
      contains: "struct AddExerciseFAB"
  key_links:
    - from: "ExerciseSectionView"
      to: "swipeActions"
      via: "delete modifier on set row"
      pattern: "\\.swipeActions"
---

<objective>
Create the exercise section container with collapsible UI and the exercise picker for adding exercises to workouts.

Purpose: Users need to organize exercises in their workout (collapsible sections, add/remove) and quickly add new exercises from their library. The FAB provides persistent access to adding exercises.

Output: ExerciseSectionView with DisclosureGroup and swipe-to-delete, ExercisePickerSheet with search, AddExerciseFAB component.
</objective>

<execution_context>
@/Users/opera_user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/opera_user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-workout-logging/04-CONTEXT.md
@.planning/phases/04-workout-logging/04-RESEARCH.md
@.planning/phases/04-workout-logging/04-02-SUMMARY.md
@GymAnals/Models/Core/Exercise.swift
@GymAnals/Features/ExerciseLibrary/Views/ExerciseRow.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExerciseSectionView with collapsible sets</name>
  <files>
    GymAnals/Features/Workout/Views/ExerciseSectionView.swift
  </files>
  <action>
Create ExerciseSectionView.swift:
```swift
struct ExerciseSectionView: View {
    let exercise: Exercise
    let sets: [WorkoutSet]
    @Binding var isExpanded: Bool
    let onDeleteSet: (WorkoutSet) -> Void
    let onAddSet: () -> Void
    let onDeleteExercise: () -> Void

    // For set row bindings
    let repsBinding: (WorkoutSet) -> Binding<Int>
    let weightBinding: (WorkoutSet) -> Binding<Double>
    let previousReps: (WorkoutSet) -> Int?
    let previousWeight: (WorkoutSet) -> Double?
    let timerForSet: (WorkoutSet) -> SetTimer?
    let onConfirmSet: (WorkoutSet) -> Void
    let onTimerTap: (SetTimer) -> Void

    @FocusState.Binding var focusedField: SetEntryField?
    let weightUnit: WeightUnit
}
```

Use DisclosureGroup with isExpanded binding:
- Label: Exercise header showing displayName, primary muscle (if available), with drag handle icon
- Content: ForEach over sets with SetRowView, plus "+ Add Set" button

Each SetRowView in ForEach:
- Use swipeActions(edge: .trailing, allowsFullSwipe: true) with destructive delete button
- Pass all bindings and callbacks through

"+ Add Set" button:
- Label("Add Set", systemImage: "plus")
- .buttonStyle(.plain)
- Calls onAddSet

Add swipeActions on the entire DisclosureGroup for deleting exercise:
- Button with role: .destructive
- Label("Remove", systemImage: "trash")
- Calls onDeleteExercise

Styling:
- Section within card-like container (.background(.regularMaterial, in: RoundedRectangle))
- Consistent padding
  </action>
  <verify>Build succeeds. DisclosureGroup expands/collapses, swipe actions work.</verify>
  <done>ExerciseSectionView provides collapsible exercise container with SetRowViews, swipe-to-delete on both sets and exercise, and add set button.</done>
</task>

<task type="auto">
  <name>Task 2: Create ExercisePickerSheet</name>
  <files>
    GymAnals/Features/Workout/Views/ExercisePickerSheet.swift
  </files>
  <action>
Create ExercisePickerSheet.swift:
```swift
struct ExercisePickerSheet: View {
    @Environment(\.dismiss) private var dismiss
    @Query(sort: \Exercise.lastUsedDate, order: .reverse) private var exercises: [Exercise]
    @State private var searchText = ""

    let onSelectExercise: (Exercise) -> Void
}
```

Computed filteredExercises:
- If searchText.isEmpty, return first 50 exercises (recent by lastUsedDate)
- Otherwise, filter by displayName containing searchText (case insensitive)

Body:
- NavigationStack wrapper
- List of filteredExercises
- Each row is a Button that calls onSelectExercise and dismiss
- Reuse existing ExerciseRow component for display
- .tint(.primary) on button to maintain row styling

Navigation setup:
- .navigationTitle("Add Exercise")
- .navigationBarTitleDisplayMode(.inline)
- .searchable(text: $searchText, prompt: "Search exercises")
- Toolbar with cancellationAction Button("Cancel") that dismisses

Import SwiftData for @Query.
  </action>
  <verify>Build succeeds. Sheet shows exercises sorted by recent usage, searchable.</verify>
  <done>ExercisePickerSheet allows users to search and select exercises from their library, sorted by recent usage.</done>
</task>

<task type="auto">
  <name>Task 3: Create AddExerciseFAB component</name>
  <files>
    GymAnals/Features/Workout/Components/AddExerciseFAB.swift
  </files>
  <action>
Create AddExerciseFAB.swift:
```swift
struct AddExerciseFAB: View {
    let action: () -> Void

    var body: some View {
        Button(action: action) {
            Image(systemName: "plus")
                .font(.title2.bold())
                .foregroundStyle(.white)
                .frame(width: 56, height: 56)
                .background(Color.accentColor, in: Circle())
                .shadow(color: .black.opacity(0.15), radius: 4, y: 2)
        }
        .buttonStyle(.plain)
    }
}
```

Simple floating action button component.
Position in parent view via ZStack with .bottomTrailing alignment.
Padding applied by parent (typically .padding()).
  </action>
  <verify>Build succeeds. FAB renders as circular button with plus icon.</verify>
  <done>AddExerciseFAB provides a prominent floating button for triggering exercise picker, positioned by parent view.</done>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild -scheme GymAnals -destination 'platform=iOS Simulator,name=iPhone 16' build`
2. ExerciseSectionView DisclosureGroup expands/collapses
3. Swipe left on SetRowView shows delete option
4. ExercisePickerSheet shows exercises sorted by recent usage
5. Search filters exercises by name
6. FAB renders as 56x56 circular button with shadow
</verification>

<success_criteria>
- Exercise sections collapse/expand via DisclosureGroup
- Swipe-to-delete works on both sets and exercises
- "+Add Set" button within each exercise section
- Exercise picker shows recent exercises first
- Search works for finding exercises by name
- FAB is visually prominent and accessible
</success_criteria>

<output>
After completion, create `.planning/phases/04-workout-logging/04-04-SUMMARY.md`
</output>
